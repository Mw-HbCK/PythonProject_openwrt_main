# Bandix Monitor 二进制部署完整指南

## 📦 概述

本文档说明如何将 Bandix Monitor 编译为二进制文件并在 Ubuntu 24.04 上部署。

## 🎯 优势

- ✅ **无需安装 Python 环境**：二进制文件包含所有依赖
- ✅ **部署简单**：只需复制文件即可运行
- ✅ **版本一致**：避免环境差异导致的问题
- ✅ **保护源码**：代码已编译为二进制

## 📋 编译步骤

### 1. 准备编译环境

```bash
# 在 Ubuntu 24.04 系统上
sudo apt update
sudo apt install -y python3 python3-pip python3-venv git build-essential
```

### 2. 获取项目代码

```bash
cd /tmp
git clone <your-repo> bandix-monitor
cd bandix-monitor
```

### 3. 运行打包脚本

```bash
# 方法一：使用完整脚本（推荐）
chmod +x build/build_binary.sh
./build/build_binary.sh

# 方法二：使用简化脚本
chmod +x build/build_binary_simple.sh
./build/build_binary_simple.sh
```

### 4. 获取打包结果

打包完成后，二进制文件位于：
- `build/dist/bandix-monitor/bandix-monitor` - 可执行文件
- `build/dist/bandix-monitor-*.tar.gz` - 完整部署包

## 🚀 部署步骤

### 步骤 1: 上传部署包

```bash
# 将部署包上传到目标服务器
scp build/dist/bandix-monitor-*.tar.gz user@server:/tmp/
```

### 步骤 2: 解压部署包

```bash
# SSH 登录服务器
ssh user@server

# 解压部署包
cd /opt
sudo tar -xzf /tmp/bandix-monitor-*.tar.gz
sudo mv bandix-monitor-* bandix-monitor
```

### 步骤 3: 安装系统依赖

```bash
# 安装必要的系统库
sudo apt update
sudo apt install -y libssl3 libffi8 libsqlite3-0
```

### 步骤 4: 配置应用

```bash
cd /opt/bandix-monitor

# 编辑配置文件
nano app/config/bandix_config.ini
```

### 步骤 5: 设置权限

```bash
# 创建专用用户
sudo useradd -m -s /bin/bash bandix

# 设置文件权限
sudo chown -R bandix:bandix /opt/bandix-monitor
sudo chmod +x /opt/bandix-monitor/bandix-monitor
sudo chmod +x /opt/bandix-monitor/start.sh

# 创建必要目录
sudo -u bandix mkdir -p /opt/bandix-monitor/{logs,backups,reports,instance}
```

### 步骤 6: 配置 systemd 服务

```bash
# 编辑服务文件
sudo nano /opt/bandix-monitor/bandix-monitor.service

# 修改路径（如果需要）
# WorkingDirectory=/opt/bandix-monitor
# ExecStart=/opt/bandix-monitor/bandix-monitor

# 复制到 systemd 目录
sudo cp /opt/bandix-monitor/bandix-monitor.service /etc/systemd/system/

# 启用并启动服务
sudo systemctl daemon-reload
sudo systemctl enable bandix-monitor
sudo systemctl start bandix-monitor

# 检查状态
sudo systemctl status bandix-monitor
```

## ⚙️ 配置说明

### 环境变量

在 systemd 服务文件中设置：

```ini
[Service]
Environment="FLASK_ENV=production"
Environment="SECRET_KEY=your-secret-key"
Environment="API_HOST=0.0.0.0"
Environment="API_PORT=5000"
```

### 配置文件

编辑 `app/config/bandix_config.ini`：

```ini
[bandix]
url = http://10.0.0.1/ubus
username = root
password = your-password

[api]
host = 0.0.0.0
port = 5000
debug = false
auth_enabled = true
api_key = your-strong-api-key

[database]
mysql_host = localhost
mysql_port = 3306
mysql_user = hanbo
mysql_password = your-strong-password
mysql_database = bandix_monitor
```

## 🔍 验证部署

```bash
# 检查服务状态
sudo systemctl status bandix-monitor

# 查看日志
sudo journalctl -u bandix-monitor -f
tail -f /opt/bandix-monitor/logs/app.log

# 测试 API
curl http://localhost:5000/health
curl http://localhost:5000/api/docs
```

## 🛠️ 常用操作

### 启动/停止服务

```bash
sudo systemctl start bandix-monitor
sudo systemctl stop bandix-monitor
sudo systemctl restart bandix-monitor
sudo systemctl status bandix-monitor
```

### 查看日志

```bash
# systemd 日志
sudo journalctl -u bandix-monitor -n 100 -f

# 应用日志
tail -f /opt/bandix-monitor/logs/app.log
tail -f /opt/bandix-monitor/logs/app_error.log
```

### 更新应用

```bash
# 1. 停止服务
sudo systemctl stop bandix-monitor

# 2. 备份
sudo cp -r /opt/bandix-monitor /opt/bandix-monitor.backup

# 3. 上传新版本
# (上传新的二进制文件)

# 4. 复制配置文件和数据
sudo cp /opt/bandix-monitor.backup/app/config/bandix_config.ini \
        /opt/bandix-monitor/app/config/
sudo cp -r /opt/bandix-monitor.backup/instance/* \
           /opt/bandix-monitor/instance/ 2>/dev/null || true

# 5. 设置权限
sudo chmod +x /opt/bandix-monitor/bandix-monitor
sudo chown -R bandix:bandix /opt/bandix-monitor

# 6. 启动服务
sudo systemctl start bandix-monitor
```

## 🔒 安全建议

1. **使用非 root 用户运行**
   ```bash
   sudo useradd -m -s /bin/bash bandix
   sudo chown -R bandix:bandix /opt/bandix-monitor
   ```

2. **配置防火墙**
   ```bash
   sudo ufw allow 5000/tcp
   sudo ufw enable
   ```

3. **使用 Nginx 反向代理**
   - 参考 `deploy/nginx/bandix-monitor.conf`
   - 配置 SSL 证书

4. **修改默认密码和密钥**
   - 修改 API Key
   - 修改数据库密码
   - 设置强 SECRET_KEY

## 🐛 故障排查

### 二进制文件无法运行

```bash
# 检查文件权限
ls -l /opt/bandix-monitor/bandix-monitor

# 检查依赖库
ldd /opt/bandix-monitor/bandix-monitor

# 安装缺失的系统库
sudo apt install -y libssl3 libffi8 libsqlite3-0 libc6
```

### 服务无法启动

```bash
# 查看详细错误
sudo journalctl -u bandix-monitor -n 100 --no-pager

# 手动运行测试
cd /opt/bandix-monitor
sudo -u bandix ./bandix-monitor
```

### 配置文件找不到

确保配置文件位于正确位置：
```bash
ls -l /opt/bandix-monitor/app/config/bandix_config.ini
```

或设置环境变量：
```bash
export BANDIX_CONFIG=/path/to/bandix_config.ini
```

### 数据库连接失败

```bash
# 检查 MySQL 服务
sudo systemctl status mysql

# 测试数据库连接
mysql -u hanbo -p -h localhost bandix_monitor
```

## 📊 性能优化

1. **使用 systemd 管理服务**（已配置）
2. **配置 Nginx 反向代理**（参考部署文档）
3. **启用数据库连接池**
4. **定期清理日志和旧数据**

## 📝 注意事项

1. **文件大小**：二进制文件约 100-200MB
2. **系统兼容性**：需要在相同架构（x86_64）的系统上运行
3. **系统库**：目标系统需要安装必要的系统库
4. **配置文件**：首次运行前必须配置
5. **数据库**：确保数据库服务已启动

## 🔄 从源码部署迁移

如果之前使用源码部署：

```bash
# 1. 备份当前部署
sudo cp -r /opt/bandix-monitor /opt/bandix-monitor.backup

# 2. 停止服务
sudo systemctl stop bandix-monitor

# 3. 部署二进制文件
# (按照上述步骤部署)

# 4. 复制配置和数据
sudo cp /opt/bandix-monitor.backup/app/config/bandix_config.ini \
        /opt/bandix-monitor/app/config/
sudo cp -r /opt/bandix-monitor.backup/instance/* \
           /opt/bandix-monitor/instance/ 2>/dev/null || true

# 5. 启动服务
sudo systemctl start bandix-monitor
```

## 📚 相关文档

- [完整部署文档](DEPLOY_UBUNTU.md)
- [快速部署指南](QUICK_START_UBUNTU.md)
- [二进制打包说明](build/README.md)
- [二进制部署文档](build/BINARY_DEPLOY.md)

---

**提示**：二进制部署适合生产环境，无需担心 Python 环境问题。如需频繁更新代码，建议使用源码部署。

