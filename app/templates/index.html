<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandix Monitor - ç”¨æˆ·ä¸­å¿ƒ</title>
    <style>
        /* CSSå˜é‡å®šä¹‰ - äº®è‰²ä¸»é¢˜ */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e0e0e0;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --text-inverse: #ffffff;
            --border-color: #e0e0e0;
            --border-color-light: #eee;
            --accent-color: #667eea;
            --accent-hover: #764ba2;
            --success-bg: #efe;
            --success-text: #3c3;
            --success-border: #cfc;
            --error-bg: #fee;
            --error-text: #c33;
            --error-border: #fcc;
            --shadow: rgba(0,0,0,0.3);
            --shadow-accent: rgba(102, 126, 234, 0.3);
            --shadow-hover: rgba(102, 126, 234, 0.4);
            --status-online: #28a745;
            --status-offline: #dc3545;
            --btn-secondary-bg: #6c757d;
            --btn-secondary-hover: #5a6268;
            --card-info-bg: #e3f2fd;
        }
        
        /* CSSå˜é‡å®šä¹‰ - æš—è‰²ä¸»é¢˜ */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --bg-gradient: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --text-inverse: #ffffff;
            --border-color: #404040;
            --border-color-light: #333333;
            --accent-color: #667eea;
            --accent-hover: #7c8fee;
            --success-bg: #1e3a1e;
            --success-text: #4ade80;
            --success-border: #22c55e;
            --error-bg: #3a1e1e;
            --error-text: #f87171;
            --error-border: #ef4444;
            --shadow: rgba(0,0,0,0.5);
            --shadow-accent: rgba(102, 126, 234, 0.4);
            --shadow-hover: rgba(102, 126, 234, 0.5);
            --status-online: #22c55e;
            --status-offline: #ef4444;
            --btn-secondary-bg: #4a5568;
            --btn-secondary-hover: #5a6268;
            --card-info-bg: #1e3a52;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* ç¾åŒ–æ»šåŠ¨æ¡ - Firefox */
            scrollbar-width: thin;
            scrollbar-color: #667eea var(--bg-secondary);
        }
        
        /* ç¾åŒ–æ»šåŠ¨æ¡ - Webkitæµè§ˆå™¨ (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
            transition: background 0.3s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        /* æš—è‰²ä¸»é¢˜ä¸‹çš„æ»šåŠ¨æ¡ */
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border-color: var(--bg-tertiary);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        }
        
        [data-theme="dark"] * {
            scrollbar-color: #4a5568 var(--bg-tertiary);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .container {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 20px 60px var(--shadow);
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px;
            transition: background 0.3s ease;
        }
        
        .login-container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        input[type="number"],
        input[type="datetime-local"] {
            font-size: 14px;
            padding: 10px;
        }
        
        input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        input[type="number"]:focus,
        input[type="datetime-local"]:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: var(--bg-gradient);
            color: var(--text-inverse);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-hover);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .link {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
        }
        
        .link a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .link a:hover {
            text-decoration: underline;
        }
        
        .error {
            background: var(--error-bg);
            color: var(--error-text);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--error-border);
        }
        
        .success {
            background: var(--success-bg);
            color: var(--success-text);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--success-border);
        }
        
        /* ä¸»å¸ƒå±€æ ·å¼ */
        .main-layout {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 220px;
            min-width: 220px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ï¼ˆä¾§è¾¹æ æŒ‰é’®ï¼‰ */
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-left: 3px solid transparent;
            transition: all 0.3s;
            width: 100%;
            text-align: left;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: var(--accent-color);
            background: var(--bg-primary);
        }
        
        .tab.active {
            color: var(--accent-color);
            background: var(--bg-primary);
            border-left-color: var(--accent-color);
            font-weight: 600;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            min-width: 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* APIæ–‡æ¡£é“¾æ¥æ ·å¼ï¼ˆä¾§è¾¹æ ï¼‰ */
        .api-doc-link {
            margin-top: auto;
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-left: 3px solid transparent;
            border-top: 1px solid var(--border-color);
            transition: all 0.3s;
            white-space: nowrap;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 0;
            margin-right: 0;
            margin-bottom: 0;
            width: 100%;
            text-align: left;
        }
        
        .api-doc-link:hover {
            color: var(--accent-color);
            background: var(--bg-primary);
            text-decoration: none;
        }
        
        .api-doc-link-icon {
            font-size: 16px;
        }
        
        
        .user-info {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }
        
        .user-info h2 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .info-item {
            margin-bottom: 15px;
        }
        
        .info-item label {
            font-weight: 600;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 5px;
        }
        
        .token-box {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
            color: var(--text-primary);
            position: relative;
        }
        
        .copy-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--accent-color);
            font-size: 14px;
        }
        
        .user-info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px 0;
        }
        
        .user-info-header .username-display {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .user-info-header .logout-btn {
            padding: 8px 16px !important;
            font-size: 13px !important;
            width: auto;
        }
        
        .actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .actions button {
            margin-bottom: 0;
            width: auto;
            padding: 8px 16px !important;
            font-size: 13px !important;
        }
        
        .btn-secondary {
            background: var(--btn-secondary-bg);
        }
        
        .btn-secondary:hover {
            background: var(--btn-secondary-hover);
        }
        
        /* æ•°æ®æŸ¥è¯¢æ ·å¼ */
        .data-query-content {
            padding: 0;
        }
        
        .controls {
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .control-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color-light);
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .control-group select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .btn-query {
            padding: 12px 20px;
            background: var(--bg-gradient);
            color: var(--text-inverse);
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }
        
        .btn-query:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-hover);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: background 0.3s ease;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color-light);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-primary);
        }
        
        thead {
            background: var(--bg-secondary);
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color-light);
            color: var(--text-primary);
        }
        
        tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding: 20px;
            flex-wrap: wrap;
        }
        
        .pagination button {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--accent-color);
            color: var(--text-inverse);
            border-color: var(--accent-color);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            padding: 10px 20px;
            color: var(--text-secondary);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: var(--text-tertiary);
        }
        
        /* ä»ªè¡¨ç›˜æ ·å¼ */
        .dashboard-controls {
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color-light);
            display: flex;
            gap: 20px;
            align-items: flex-end;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: var(--bg-gradient);
            border-radius: 12px;
            padding: 25px;
            color: var(--text-inverse);
            box-shadow: 0 4px 15px var(--shadow-accent);
        }
        
        .dashboard-card .card-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .dashboard-card .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .dashboard-card .card-unit {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .dashboard-card .card-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .dashboard-section {
            margin-bottom: 30px;
        }
        
        .dashboard-section h2 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        
        .dashboard-section h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        
        .system-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        
        .status-label {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .status-value {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        #rankingTable {
            width: 100%;
            margin-top: 15px;
        }
        
        #rankingTable th {
            background: var(--bg-secondary);
            font-weight: 600;
        }
        
        .device-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .device-status.online {
            background: var(--status-online);
        }
        
        .device-status.offline {
            background: var(--status-offline);
        }
        
        /* RadioæŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .radio-option {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        
        @media (max-width: 768px) {
            .radio-option {
                min-width: 100%;
            }
        }
        
        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            width: 0;
            height: 0;
        }
        
        .radio-option label {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0;
        }
        
        .radio-option label:hover {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .radio-option input[type="radio"]:checked + label {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .radio-option label::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            margin-right: 12px;
            display: inline-block;
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .radio-option input[type="radio"]:checked + label::before {
            border-color: var(--accent-color);
            background: var(--accent-color);
            box-shadow: 0 0 0 4px var(--bg-primary), 0 0 0 6px var(--accent-color);
        }
        
        .radio-option label::after {
            content: '';
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .radio-option input[type="radio"]:checked + label::after {
            opacity: 1;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px var(--shadow);
        }
        
        .modal-content h2 {
            margin-top: 0;
            color: var(--text-primary);
        }
        
        .modal-form-group {
            margin-bottom: 20px;
        }
        
        .modal-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .modal-form-group input,
        .modal-form-group select,
        .modal-form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .modal-form-group input:focus,
        .modal-form-group select:focus,
        .modal-form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .modal-form-group small {
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .modal-button {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-button:hover {
            background: var(--bg-secondary);
        }
        
        .modal-button-primary {
            background: var(--bg-gradient);
            color: var(--text-inverse);
            border: none;
        }
        
        .modal-button-primary:hover {
            box-shadow: 0 2px 8px var(--shadow-hover);
        }
        
        /* æ´»åŠ¨å‘Šè­¦æ  */
        .active-alerts-bar {
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .active-alerts-bar h3 {
            color: var(--error-text);
            margin-bottom: 10px;
        }
        
        .active-alert-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            border-left: 4px solid var(--error-border);
        }
        
        .active-alert-item:last-child {
            margin-bottom: 0;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-container {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .loading-container .loading-spinner {
            margin-bottom: 15px;
        }
        
        /* éª¨æ¶å± */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 4px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 10px;
        }
        
        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 20px;
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            padding: 10px;
            width: 44px;
            height: 44px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .theme-toggle:hover {
            background: var(--bg-secondary);
            transform: scale(1.05);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .main-layout {
                flex-direction: column;
                gap: 15px;
            }
            
            .sidebar {
                width: 100%;
                min-width: unset;
                position: static;
                padding: 10px 0;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .api-doc-link {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .api-doc-link span:not(.api-doc-link-icon) {
                display: inline;
            }
            
            .main-content {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .control-group {
                width: 100%;
                min-width: unset;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .system-status-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 95vh;
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 8px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .modal-button {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .dashboard-card {
                padding: 20px;
            }
            
            .dashboard-card .card-value {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
        ğŸŒ™
    </button>
    
    <!-- ç™»å½•/æ³¨å†Œè¡¨å• -->
    <div id="authContainer" class="container login-container">
        <div id="loginForm">
            <h1>ç”¨æˆ·ç™»å½•</h1>
            <div id="message"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit">ç™»å½•</button>
            </form>
            <div class="link">
                è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showRegister(); return false;">ç«‹å³æ³¨å†Œ</a>
            </div>
        </div>
        
        <div id="registerForm" style="display: none;">
            <h1>ç”¨æˆ·æ³¨å†Œ</h1>
            <div id="register-message"></div>
            <form id="register-form">
                <div class="form-group">
                    <label for="reg-username">ç”¨æˆ·å</label>
                    <input type="text" id="reg-username" name="username" required minlength="3">
                </div>
                <div class="form-group">
                    <label for="reg-password">å¯†ç </label>
                    <input type="password" id="reg-password" name="password" required minlength="6">
                </div>
                <button type="submit">æ³¨å†Œ</button>
            </form>
            <div class="link">
                å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showLogin(); return false;">ç«‹å³ç™»å½•</a>
            </div>
            </div>
        </div>
        
    <!-- ç”¨æˆ·ä¸­å¿ƒ -->
    <div id="userCenter" class="container" style="display: none;">
        <h1>Bandix Monitor - ç”¨æˆ·ä¸­å¿ƒ</h1>
            <div id="user-message"></div>
        
        <!-- ä¾§è¾¹æ å’Œä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-layout">
            <!-- ä¾§è¾¹æ å¯¼èˆª -->
            <div class="sidebar">
                <button class="tab active" onclick="switchTab('userInfo')">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</button>
                <button class="tab" onclick="switchTab('dashboard')">ğŸ“Š å®æ—¶ç›‘æ§</button>
                <button class="tab" onclick="switchTab('charts')">ğŸ“ˆ æ•°æ®å›¾è¡¨</button>
                <button class="tab" onclick="switchTab('statistics')">ğŸ“Š ç»Ÿè®¡åˆ†æ</button>
                <button class="tab" onclick="switchTab('dataManagement')">ğŸ—„ï¸ æ•°æ®ç®¡ç†</button>
                <button class="tab" onclick="switchTab('alerts')">ğŸ”” å‘Šè­¦ç®¡ç†</button>
                <button class="tab" onclick="switchTab('dataQuery')">ğŸ“Š æ•°æ®æŸ¥è¯¢</button>
                <button class="tab" onclick="switchTab('config')" id="configTabBtn" style="display: none;">âš™ï¸ é…ç½®ç®¡ç†</button>
                <button class="tab" onclick="switchTab('userManagement')" id="userManagementTabBtn" style="display: none;">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</button>
                <a href="/api/docs" target="_blank" class="api-doc-link" title="æŸ¥çœ‹APIæ–‡æ¡£">
                    <span class="api-doc-link-icon">ğŸ“š</span>
                    <span>APIæ–‡æ¡£</span>
                </a>
            </div>
            
            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <!-- ç”¨æˆ·ä¿¡æ¯æ ‡ç­¾é¡µ -->
        <div id="userInfoTab" class="tab-content active">
            <div id="user-info-header" class="user-info-header"></div>
            <div id="user-info" class="user-info"></div>
            <div class="actions">
                <button class="copy-btn" onclick="refreshToken()">åˆ·æ–° Token</button>
            </div>
        </div>
        
        <!-- å®æ—¶ç›‘æ§ä»ªè¡¨ç›˜æ ‡ç­¾é¡µ -->
        <div id="dashboardTab" class="tab-content">
            <div class="data-query-content">
                <div class="dashboard-controls">
                    <div class="control-group" style="flex: 0 0 auto; min-width: auto;">
                        <label>åˆ·æ–°é—´éš”</label>
                        <select id="refreshIntervalSelect">
                            <option value="1">1ç§’</option>
                            <option value="2">2ç§’</option>
                            <option value="5">5ç§’</option>
                            <option value="10" selected>10ç§’</option>
                            <option value="30">30ç§’</option>
                            <option value="0">æ‰‹åŠ¨åˆ·æ–°</option>
                        </select>
                    </div>
                    <div class="control-group" style="flex: 0 0 auto; min-width: auto; align-self: flex-end;">
                        <button class="btn-query" onclick="manualRefreshDashboard()">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
                    </div>
                </div>
                
                <div id="dashboardError" class="error" style="display: none;"></div>
                
                <!-- å®æ—¶æµé‡å¡ç‰‡ -->
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="card-label">å½“å‰ä¸‹è¡Œé€Ÿç‡</div>
                        <div class="card-value" id="currentDownSpeed">-</div>
                        <div class="card-subtitle" id="currentDownSpeedFormatted">-</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-label">å½“å‰ä¸Šè¡Œé€Ÿç‡</div>
                        <div class="card-value" id="currentUpSpeed">-</div>
                        <div class="card-subtitle" id="currentUpSpeedFormatted">-</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-label">æ€»ä¸‹è½½æµé‡</div>
                        <div class="card-value" id="totalDownload">-</div>
                        <div class="card-subtitle" id="totalDownloadFormatted">-</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-label">æ€»ä¸Šä¼ æµé‡</div>
                        <div class="card-value" id="totalUpload">-</div>
                        <div class="card-subtitle" id="totalUploadFormatted">-</div>
                    </div>
                </div>
                
                <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
                <div class="dashboard-section">
                    <h3>ç³»ç»ŸçŠ¶æ€</h3>
                    <div class="system-status-grid">
                        <div class="status-item">
                            <span class="status-label">æ•°æ®æ”¶é›†æœåŠ¡:</span>
                            <span class="status-value" id="collectorStatus">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ•°æ®åº“è®°å½•æ•°:</span>
                            <span class="status-value" id="totalRecords">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">è®¾å¤‡æ€»æ•°:</span>
                            <span class="status-value" id="deviceCount">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æœ€æ–°æ•°æ®æ—¶é—´:</span>
                            <span class="status-value" id="latestDataTime">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- è®¾å¤‡åˆ—è¡¨å’Œæ’è¡Œæ¦œ -->
                <div class="dashboard-section">
                    <h3>è®¾å¤‡çŠ¶æ€ä¸æµé‡æ’è¡Œæ¦œ</h3>
                    <div id="deviceRankingTable" class="table-container" style="display: none;">
                        <table id="rankingTable">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>è®¾å¤‡åç§°</th>
                                    <th>MACåœ°å€</th>
                                    <th>IPåœ°å€</th>
                                    <th>ä¸‹è¡Œé€Ÿç‡</th>
                                    <th>ä¸Šè¡Œé€Ÿç‡</th>
                                    <th>æ€»æµé‡</th>
                                    <th>æœ€åæ´»è·ƒ</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="rankingEmpty" class="empty" style="display: none;">
                        æš‚æ— è®¾å¤‡æ•°æ®
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®å›¾è¡¨æ ‡ç­¾é¡µ -->
        <div id="chartsTab" class="tab-content">
            <div class="data-query-content">
                <div class="controls">
                    <div class="control-group">
                        <label>å›¾è¡¨ç±»å‹</label>
                        <select id="chartTypeSelect">
                            <option value="traffic_trend">æµé‡è¶‹åŠ¿å›¾</option>
                            <option value="device_comparison">è®¾å¤‡å¯¹æ¯”å›¾</option>
                        </select>
                    </div>
                    
                    <div class="control-group" id="deviceSelectorGroup" style="display: none;">
                        <label>è®¾å¤‡ï¼ˆæµé‡è¶‹åŠ¿å›¾ï¼‰</label>
                        <select id="chartDeviceSelect">
                            <option value="total">å…¨ç½‘æµé‡</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>æ—¶é—´èŒƒå›´</label>
                        <select id="timeRangeSelect">
                            <option value="1">æœ€è¿‘1å°æ—¶</option>
                            <option value="6">æœ€è¿‘6å°æ—¶</option>
                            <option value="24" selected>æœ€è¿‘24å°æ—¶</option>
                            <option value="72">æœ€è¿‘3å¤©</option>
                            <option value="168">æœ€è¿‘7å¤©</option>
                        </select>
                    </div>
                    
                    <div class="control-group" style="flex: 0 0 auto; min-width: auto; align-self: flex-end;">
                        <button class="btn-query" onclick="loadChart()">ğŸ“Š ç”Ÿæˆå›¾è¡¨</button>
                    </div>
                </div>
                
                <div id="chartLoading" class="loading-container" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>åŠ è½½å›¾è¡¨æ•°æ®ä¸­...</div>
                </div>
                
                <div id="chartError" class="error" style="display: none;"></div>
                
                <div id="chartsContainer" style="margin-top: 30px;">
                    <div id="trafficTrendChart" style="display: none;">
                        <canvas id="trafficTrendCanvas" style="max-height: 400px;"></canvas>
                    </div>
                    
                    <div id="deviceComparisonChart" style="display: none;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--text-primary); font-size: 16px;">å¯¹æ¯”ç±»å‹ï¼š</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="comparisonTypeSpeed" name="comparisonType" value="speed" checked onchange="loadDeviceComparison()">
                                    <label for="comparisonTypeSpeed">
                                        âš¡ é€Ÿç‡å¯¹æ¯”
                                    </label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="comparisonTypeTotal" name="comparisonType" value="total" onchange="loadDeviceComparison()">
                                    <label for="comparisonTypeTotal">
                                        ğŸ“Š æµé‡å¯¹æ¯”
                                    </label>
                                </div>
                            </div>
                        </div>
                        <canvas id="deviceComparisonCanvas" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡åˆ†ææ ‡ç­¾é¡µ -->
        <div id="statisticsTab" class="tab-content">
            <div class="data-query-content">
                <div id="statisticsError" class="error" style="display: none;"></div>
                
                <!-- æµé‡ç»Ÿè®¡æ±‡æ€»å¡ç‰‡ -->
                <div class="dashboard-section">
                    <h2>æµé‡ç»Ÿè®¡æ±‡æ€»</h2>
                    <div class="dashboard-cards">
                        <div class="dashboard-card">
                            <div class="card-label">ä»Šæ—¥ä¸‹è½½</div>
                            <div class="card-value" id="todayDownload">-</div>
                            <div class="card-unit" id="todayDownloadFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">ä»Šæ—¥ä¸Šä¼ </div>
                            <div class="card-value" id="todayUpload">-</div>
                            <div class="card-unit" id="todayUploadFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">æœ¬å‘¨ä¸‹è½½</div>
                            <div class="card-value" id="weekDownload">-</div>
                            <div class="card-unit" id="weekDownloadFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">æœ¬å‘¨ä¸Šä¼ </div>
                            <div class="card-value" id="weekUpload">-</div>
                            <div class="card-unit" id="weekUploadFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">æœ¬æœˆä¸‹è½½</div>
                            <div class="card-value" id="monthDownload">-</div>
                            <div class="card-unit" id="monthDownloadFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">æœ¬æœˆä¸Šä¼ </div>
                            <div class="card-value" id="monthUpload">-</div>
                            <div class="card-unit" id="monthUploadFormatted">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- é€Ÿç‡ç»Ÿè®¡å¡ç‰‡ -->
                <div class="dashboard-section">
                    <h2>é€Ÿç‡ç»Ÿè®¡</h2>
                    <div class="dashboard-cards">
                        <div class="dashboard-card">
                            <div class="card-label">å¹³å‡ä¸‹è¡Œé€Ÿç‡</div>
                            <div class="card-value" id="avgDownSpeed">-</div>
                            <div class="card-unit" id="avgDownSpeedFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">å¹³å‡ä¸Šè¡Œé€Ÿç‡</div>
                            <div class="card-value" id="avgUpSpeed">-</div>
                            <div class="card-unit" id="avgUpSpeedFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">å³°å€¼ä¸‹è¡Œé€Ÿç‡</div>
                            <div class="card-value" id="peakDownSpeed">-</div>
                            <div class="card-unit" id="peakDownSpeedFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">å³°å€¼ä¸Šè¡Œé€Ÿç‡</div>
                            <div class="card-value" id="peakUpSpeed">-</div>
                            <div class="card-unit" id="peakUpSpeedFormatted">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- è®¾å¤‡æ’åè¡¨æ ¼ -->
                <div class="dashboard-section">
                    <h2>è®¾å¤‡æµé‡æ’å (Top 10)</h2>
                    <div id="deviceRankingTableContainer" class="table-container">
                        <table id="statisticsDeviceRankingTable">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>è®¾å¤‡åç§°</th>
                                    <th>MACåœ°å€</th>
                                    <th>IPåœ°å€</th>
                                    <th>ä¸‹è½½æµé‡</th>
                                    <th>ä¸Šä¼ æµé‡</th>
                                    <th>æ€»æµé‡</th>
                                </tr>
                            </thead>
                            <tbody id="statisticsDeviceRankingTableBody">
                                <tr><td colspan="7" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- è®¾å¤‡æµé‡å æ¯”å›¾è¡¨ -->
                <div class="dashboard-section">
                    <h2>è®¾å¤‡æµé‡å æ¯”</h2>
                    <div style="max-width: 600px; margin: 0 auto;">
                        <canvas id="trafficDistributionChart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
                
                <!-- æ—¶é—´æ®µå¯¹æ¯”å›¾è¡¨ -->
                <div class="dashboard-section">
                    <h2>æ—¶é—´æ®µå¯¹æ¯”</h2>
                    <div style="max-width: 800px; margin: 0 auto;">
                        <canvas id="periodComparisonChart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="dataManagementTab" class="tab-content">
            <div class="data-query-content">
                <div id="dataManagementError" class="error" style="display: none;"></div>
                <div id="dataManagementSuccess" class="success" style="display: none;"></div>
                
                <!-- æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="dashboard-section">
                    <h2>æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯</h2>
                    <div class="dashboard-cards">
                        <div class="dashboard-card">
                            <div class="card-label">æ•°æ®åº“å¤§å°</div>
                            <div class="card-value" id="databaseSize">-</div>
                            <div class="card-unit" id="databaseSizeFormatted">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">å…¨ç½‘æµé‡è®°å½•æ•°</div>
                            <div class="card-value" id="totalTrafficRecords">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">è®¾å¤‡æµé‡è®°å½•æ•°</div>
                            <div class="card-value" id="deviceTrafficRecords">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-label">è®¾å¤‡æ•°é‡</div>
                            <div class="card-value" id="managementDeviceCount">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®æ¸…ç†åŒºåŸŸ -->
                <div class="dashboard-section">
                    <h2>æ•°æ®æ¸…ç†</h2>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--text-primary); font-size: 16px;">æ¸…ç†æ–¹å¼ï¼š</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="cleanupTypeKeepDays" name="cleanupType" value="keep_days" checked onchange="updateCleanupUI()">
                                    <label for="cleanupTypeKeepDays">
                                        ğŸ“… ä¿ç•™æœ€è¿‘Nå¤©çš„æ•°æ®
                                    </label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="cleanupTypeTimeRange" name="cleanupType" value="time_range" onchange="updateCleanupUI()">
                                    <label for="cleanupTypeTimeRange">
                                        ğŸ• æ‰‹åŠ¨æŒ‡å®šæ—¶é—´èŒƒå›´
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="keepDaysGroup" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 500; color: var(--text-primary);">ä¿ç•™å¤©æ•°ï¼š</label>
                            <input type="number" id="keepDays" min="1" value="30" style="padding: 10px; width: 200px; max-width: 100%; border: 2px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); transition: border-color 0.3s;">
                            <small style="display: block; margin-top: 6px; color: var(--text-secondary); font-size: 13px;">ä¿ç•™æœ€è¿‘Nå¤©çš„æ•°æ®ï¼Œè¾ƒæ—©çš„æ•°æ®å°†è¢«åˆ é™¤</small>
                        </div>
                        
                        <div id="timeRangeGroup" style="margin-bottom: 20px; display: none;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 500; color: var(--text-primary);">å¼€å§‹æ—¶é—´ï¼š</label>
                                <input type="datetime-local" id="cleanupStartTime" style="padding: 10px; width: 250px; max-width: 100%; border: 2px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); transition: border-color 0.3s;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 500; color: var(--text-primary);">ç»“æŸæ—¶é—´ï¼š</label>
                                <input type="datetime-local" id="cleanupEndTime" style="padding: 10px; width: 250px; max-width: 100%; border: 2px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); transition: border-color 0.3s;">
                            </div>
                            <small style="display: block; margin-top: 8px; color: var(--text-secondary); font-size: 13px;">æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ•°æ®å°†è¢«åˆ é™¤</small>
                        </div>
                        
                        <div id="cleanupPreview" style="margin-bottom: 15px; padding: 12px 16px; background: var(--success-bg); border: 1px solid var(--success-border); border-radius: 6px; display: none; color: var(--success-text);">
                            <strong>é¢„è§ˆï¼š</strong>å°†åˆ é™¤ <span id="previewDeleteCount" style="font-weight: 600;">0</span> æ¡è®°å½•
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn-query" onclick="previewCleanup()" style="padding: 8px 16px !important; font-size: 13px !important; width: auto;">é¢„è§ˆæ¸…ç†</button>
                            <button class="btn-query" onclick="executeCleanup()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); padding: 8px 16px !important; font-size: 13px !important; width: auto;">æ‰§è¡Œæ¸…ç†</button>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®åº“ä¼˜åŒ–åŒºåŸŸ -->
                <div class="dashboard-section">
                    <h2>æ•°æ®åº“ä¼˜åŒ–</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin-bottom: 15px; color: #666;">
                            VACUUMå‘½ä»¤å°†é‡å»ºæ•°æ®åº“æ–‡ä»¶ï¼Œå›æ”¶æœªä½¿ç”¨çš„ç©ºé—´ï¼Œä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ã€‚å»ºè®®åœ¨æ•°æ®æ¸…ç†åæ‰§è¡Œã€‚
                        </p>
                        <div style="display: flex; justify-content: flex-end;">
                            <button class="btn-query" onclick="executeVacuum()" style="padding: 8px 16px !important; font-size: 13px !important; width: auto;">æ‰§è¡Œä¼˜åŒ–</button>
                        </div>
                        <div id="vacuumResult" style="margin-top: 15px; display: none;"></div>
                    </div>
                </div>
                
                <!-- æ•°æ®å¤‡ä»½åŒºåŸŸ -->
                <div class="dashboard-section">
                    <h2>æ•°æ®å¤‡ä»½</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <p style="margin-bottom: 15px; color: #666;">
                            å¯¼å‡ºæ•°æ®åº“ä¸ºSQLæ–‡ä»¶ï¼Œå¯ç”¨äºæ•°æ®æ¢å¤ã€‚å¤‡ä»½æ–‡ä»¶åŒ…å«æ‰€æœ‰è¡¨ç»“æ„å’Œæ•°æ®ã€‚
                        </p>
                        <div style="display: flex; justify-content: flex-end;">
                            <button class="btn-query" onclick="downloadBackup()" style="padding: 8px 16px !important; font-size: 13px !important; width: auto;">ä¸‹è½½å¤‡ä»½</button>
                        </div>
                        <div id="backupInfo" style="margin-top: 15px; padding: 10px; background: white; border-radius: 4px; display: none;">
                            <div><strong>æ•°æ®åº“å¤§å°ï¼š</strong><span id="backupDatabaseSize">-</span></div>
                            <div style="margin-top: 5px;"><strong>è®°å½•æ•°ï¼š</strong><span id="backupRecordCount">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å‘Šè­¦ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="alertsTab" class="tab-content">
            <div class="data-query-content">
                <div id="alertsError" class="error" style="display: none;"></div>
                <div id="alertsSuccess" class="success" style="display: none;"></div>
                
                <!-- å‘Šè­¦è§„åˆ™ç®¡ç† -->
                <div class="dashboard-section">
                    <h2>å‘Šè­¦è§„åˆ™ç®¡ç†</h2>
                    <div style="margin-bottom: 20px; display: flex; justify-content: flex-end;">
                        <button class="btn-query" onclick="showCreateRuleForm()" style="padding: 8px 16px !important; font-size: 13px !important; width: auto !important;">â• æ–°å»ºè§„åˆ™</button>
                    </div>
                    
                    <!-- è§„åˆ™åˆ—è¡¨ -->
                    <div id="rulesTableContainer" class="table-container">
                        <table id="rulesTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">è§„åˆ™åç§°</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">å‘Šè­¦ç±»å‹</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">é˜ˆå€¼/æ¡ä»¶</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">ä¸¥é‡ç¨‹åº¦</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">çŠ¶æ€</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="rulesTableBody">
                                <tr>
                                    <td colspan="6" style="padding: 20px; text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- æ–°å»º/ç¼–è¾‘è§„åˆ™è¡¨å•ï¼ˆæ¨¡æ€æ¡†ï¼‰ -->
                <div id="ruleFormModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h2 id="ruleFormTitle" style="margin-top: 0;">æ–°å»ºå‘Šè­¦è§„åˆ™</h2>
                        <form id="ruleForm" onsubmit="saveRule(event)">
                            <input type="hidden" id="ruleId" value="">
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">è§„åˆ™åç§° *</label>
                                <input type="text" id="ruleName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">å‘Šè­¦ç±»å‹ *</label>
                                <select id="ruleType" required onchange="updateRuleForm()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    <option value="traffic_threshold">æµé‡é˜ˆå€¼å‘Šè­¦</option>
                                    <option value="device_offline">è®¾å¤‡ç¦»çº¿å‘Šè­¦</option>
                                </select>
                            </div>
                            
                            <div id="trafficThresholdFields" style="display: none; margin-bottom: 20px;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">æµé‡é˜ˆå€¼ (å­—èŠ‚/ç§’) *</label>
                                    <input type="number" id="thresholdBytes" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <small style="color: #666;">ä¾‹å¦‚: 1048576 è¡¨ç¤º 1MB/s (1048576 å­—èŠ‚/ç§’)</small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">ç›®æ ‡è®¾å¤‡</label>
                                    <select id="ruleDeviceId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">æ‰€æœ‰è®¾å¤‡ï¼ˆå…¨ç½‘æµé‡ï¼‰</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="offlineThresholdFields" style="display: none; margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">ç¦»çº¿é˜ˆå€¼ (åˆ†é’Ÿ) *</label>
                                <input type="number" id="offlineThresholdMinutes" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <small style="color: #666;">è®¾å¤‡è¶…è¿‡æ­¤æ—¶é—´æœªæ´»åŠ¨å°†è§¦å‘å‘Šè­¦</small>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">ä¸¥é‡ç¨‹åº¦ *</label>
                                <select id="ruleSeverity" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="warning">è­¦å‘Š (é»„è‰²)</option>
                                    <option value="critical">ä¸¥é‡ (çº¢è‰²)</option>
                                    <option value="info">ä¿¡æ¯ (è“è‰²)</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="ruleEnabled" checked style="margin-right: 8px;">
                                    <span>å¯ç”¨è§„åˆ™</span>
                                </label>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeRuleForm()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                                <button type="submit" style="padding: 10px 20px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- å‘Šè­¦å†å² -->
                <div class="dashboard-section" style="margin-top: 40px;">
                    <h2>å‘Šè­¦å†å²</h2>
                    
                    <!-- ç­›é€‰æ¡ä»¶ -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">çŠ¶æ€</label>
                                <select id="historyStatusFilter" onchange="loadAlertHistory()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="triggered">å·²è§¦å‘</option>
                                    <option value="acknowledged">å·²ç¡®è®¤</option>
                                    <option value="resolved">å·²è§£å†³</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å‘Šè­¦ç±»å‹</label>
                                <select id="historyTypeFilter" onchange="loadAlertHistory()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="traffic_threshold">æµé‡é˜ˆå€¼</option>
                                    <option value="device_offline">è®¾å¤‡ç¦»çº¿</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä¸¥é‡ç¨‹åº¦</label>
                                <select id="historySeverityFilter" onchange="loadAlertHistory()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="critical">ä¸¥é‡</option>
                                    <option value="warning">è­¦å‘Š</option>
                                    <option value="info">ä¿¡æ¯</option>
                                </select>
                            </div>
                            <div>
                                <button class="btn-query" onclick="loadAlertHistory()">ğŸ” ç­›é€‰</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‘Šè­¦å†å²åˆ—è¡¨ -->
                    <div id="alertHistoryTableContainer" class="table-container">
                        <table id="alertHistoryTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">è§¦å‘æ—¶é—´</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">å‘Šè­¦ç±»å‹</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">æ¶ˆæ¯</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">ä¸¥é‡ç¨‹åº¦</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">çŠ¶æ€</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="alertHistoryTableBody">
                                <tr>
                                    <td colspan="6" style="padding: 20px; text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <div id="alertHistoryPagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px; align-items: center;">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®æŸ¥è¯¢æ ‡ç­¾é¡µ -->
        <div id="dataQueryTab" class="tab-content">
            <div class="data-query-content">
                <div class="controls">
                    <div class="control-group">
                        <label>é€‰æ‹©è¡¨</label>
                        <select id="tableSelect">
                            <option value="">-- è¯·é€‰æ‹©è¡¨ --</option>
                            <option value="total_traffic">å…¨ç½‘æµé‡ (total_traffic)</option>
                            <option value="device_traffic">è®¾å¤‡æµé‡ (device_traffic)</option>
                            <option value="devices">è®¾å¤‡ä¿¡æ¯ (devices)</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>è®¾å¤‡ (ä»…è®¾å¤‡æµé‡è¡¨)</label>
                        <select id="deviceSelect" disabled>
                            <option value="">-- åŠ è½½ä¸­ --</option>
                        </select>
                    </div>
                    
                    <div class="control-group" style="flex: 0 0 auto; min-width: auto; align-self: flex-end;">
                        <button class="btn-query" onclick="loadData()">ğŸ” æŸ¥è¯¢</button>
                    </div>
                    
                    <div class="control-group" style="flex: 0 0 auto; min-width: auto; align-self: flex-end;">
                        <button class="btn-query" onclick="exportToCSV()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ğŸ“¥ å¯¼å‡ºCSV</button>
                    </div>
                    
                    <div class="control-group" style="flex: 0 0 auto; min-width: auto; align-self: flex-end;">
                        <button class="btn-query" onclick="exportToExcel()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">ğŸ“Š å¯¼å‡ºExcel</button>
                    </div>
                </div>
                
                <div id="statsContainer" class="stats" style="display: none;"></div>
                
                <div id="loading" class="loading-container" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
                
                <div id="error" class="error" style="display: none;"></div>
                
                <div id="tableContainer" class="table-container" style="display: none;">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                
                <div id="empty" class="empty" style="display: none;">
                    æš‚æ— æ•°æ®
                </div>
                
                <div id="pagination" class="pagination" style="display: none;"></div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="userManagementTab" class="tab-content">
            <div class="data-query-content">
                <div id="userManagementError" class="error" style="display: none;"></div>
                <div id="userManagementSuccess" class="success" style="display: none;"></div>
                
                <div style="margin-bottom: 20px;">
                    <div style="margin-bottom: 10px;">
                        <h2 style="margin-bottom: 10px;">ç”¨æˆ·ç®¡ç†</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 0;">ç®¡ç†ç³»ç»Ÿç”¨æˆ·è´¦æˆ·</p>
                    </div>
                    <div style="display: flex; justify-content: flex-end;">
                        <button class="btn-query" onclick="showCreateUserDialog()" style="padding: 8px 12px !important; font-size: 13px !important; width: auto !important;">
                            â• æ–°å»º
                        </button>
                    </div>
                </div>
                
                <div id="userManagementLoading" class="loading-container" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
                
                <div id="userManagementContent" style="display: none;">
                    <!-- ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼ -->
                    <div style="overflow-x: auto;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>è§’è‰²</th>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userListTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <div id="userManagementPagination" class="pagination" style="margin-top: 20px;"></div>
                </div>
                
                <!-- ç”¨æˆ·ç¼–è¾‘/åˆ›å»ºå¯¹è¯æ¡† -->
                <div id="userEditModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 id="userEditModalTitle">ç¼–è¾‘ç”¨æˆ·</h2>
                            <button onclick="closeUserEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-primary); margin-left: auto;">&times;</button>
                        </div>
                        <form id="userEditForm" onsubmit="saveUser(event)">
                            <input type="hidden" id="editUserId" value="">
                            <div class="form-group">
                                <label for="editUsername">ç”¨æˆ·å</label>
                                <input type="text" id="editUsername" required>
                            </div>
                            <div class="form-group" id="editPasswordGroup" style="display: none;">
                                <label for="editPassword">å¯†ç </label>
                                <input type="password" id="editPassword" minlength="6">
                                <small style="color: var(--text-secondary); display: block; margin-top: 5px;">ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ï¼ˆåˆ›å»ºç”¨æˆ·æ—¶å¿…å¡«ï¼‰</small>
                            </div>
                            <div class="form-group">
                                <label for="editRole">è§’è‰²</label>
                                <select id="editRole" required>
                                    <option value="user">æ™®é€šç”¨æˆ·</option>
                                    <option value="admin">ç®¡ç†å‘˜</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="editIsActive" checked>
                                    å¯ç”¨è´¦æˆ·
                                </label>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn-secondary" onclick="closeUserEditModal()">å–æ¶ˆ</button>
                                <button type="submit" class="btn-query">ä¿å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é…ç½®ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="configTab" class="tab-content">
            <div class="data-query-content">
                <div id="configError" class="error" style="display: none;"></div>
                <div id="configSuccess" class="success" style="display: none;"></div>
                
                <div style="margin-bottom: 20px;">
                    <h2 style="margin-bottom: 10px;">ç³»ç»Ÿé…ç½®ç®¡ç†</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">ç®¡ç†OpenWrtè®¾å¤‡è¿æ¥ã€APIæœåŠ¡å’Œæ•°æ®æ”¶é›†æœåŠ¡çš„é…ç½®</p>
                </div>
                
                <div id="configLoading" class="loading-container" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>åŠ è½½é…ç½®ä¸­...</div>
                </div>
                
                <form id="configForm" style="display: none;">
                    <!-- OpenWrtè®¾å¤‡é…ç½® -->
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">OpenWrtè®¾å¤‡é…ç½®</h3>
                        <div class="form-group">
                            <label for="bandixUrl">è®¾å¤‡URL</label>
                            <input type="text" id="bandixUrl" name="bandix.url" placeholder="http://10.0.0.1/ubus" required>
                        </div>
                        <div class="form-group">
                            <label for="bandixUsername">ç”¨æˆ·å</label>
                            <input type="text" id="bandixUsername" name="bandix.username" placeholder="root" required>
                        </div>
                        <div class="form-group">
                            <label for="bandixPassword">å¯†ç </label>
                            <input type="password" id="bandixPassword" name="bandix.password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                            <small style="color: var(--text-secondary); display: block; margin-top: 5px;">ç•™ç©ºåˆ™ä¸ä¿®æ”¹å½“å‰å¯†ç </small>
                        </div>
                    </div>
                    
                    <!-- APIæœåŠ¡é…ç½® -->
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">APIæœåŠ¡é…ç½®</h3>
                        <div class="form-group">
                            <label for="apiHost">ç›‘å¬åœ°å€</label>
                            <input type="text" id="apiHost" name="api.host" placeholder="0.0.0.0" required>
                        </div>
                        <div class="form-group">
                            <label for="apiPort">ç«¯å£</label>
                            <input type="number" id="apiPort" name="api.port" min="1" max="65535" placeholder="5000" required>
                            <small style="color: var(--text-secondary); display: block; margin-top: 5px; color: var(--error-text);">âš ï¸ ä¿®æ”¹ç«¯å£éœ€è¦é‡å¯æœåŠ¡</small>
                        </div>
                        <div class="form-group">
                            <label for="apiDebug">è°ƒè¯•æ¨¡å¼</label>
                            <select id="apiDebug" name="api.debug" required>
                                <option value="false">å…³é—­</option>
                                <option value="true">å¼€å¯</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="apiAuthEnabled">å¯ç”¨APIé‰´æƒ</label>
                            <select id="apiAuthEnabled" name="api.auth_enabled" required>
                                <option value="true">å¯ç”¨</option>
                                <option value="false">ç¦ç”¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="apiKey">APIå¯†é’¥</label>
                            <input type="text" id="apiKey" name="api.api_key" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                            <small style="color: var(--text-secondary); display: block; margin-top: 5px;">ç•™ç©ºåˆ™ä¸ä¿®æ”¹å½“å‰å¯†é’¥</small>
                        </div>
                        <div class="form-group">
                            <label for="healthCheckRequireAuth">å¥åº·æ£€æŸ¥éœ€è¦é‰´æƒ</label>
                            <select id="healthCheckRequireAuth" name="api.health_check_require_auth" required>
                                <option value="false">ä¸éœ€è¦</option>
                                <option value="true">éœ€è¦</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- æ•°æ®æ”¶é›†æœåŠ¡é…ç½® -->
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">æ•°æ®æ”¶é›†æœåŠ¡é…ç½®</h3>
                        <div class="form-group">
                            <label for="collectInterval">æ”¶é›†é—´éš”ï¼ˆç§’ï¼‰</label>
                            <input type="number" id="collectInterval" name="collector.collect_interval" min="0.1" step="0.1" placeholder="1.0" required>
                            <small style="color: var(--text-secondary); display: block; margin-top: 5px;">æ•°æ®æ”¶é›†çš„æ—¶é—´é—´éš”ï¼Œå»ºè®®ä¸å°äº0.1ç§’</small>
                        </div>
                        <div id="collectorStatus" style="margin-top: 10px; padding: 10px; background: var(--card-info-bg); border-radius: 6px;">
                            <strong>æœåŠ¡çŠ¶æ€ï¼š</strong><span id="collectorStatusText">-</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn-query" style="flex: 1;">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button type="button" onclick="loadConfig()" class="btn-secondary" style="flex: 1;">ğŸ”„ é‡æ–°åŠ è½½</button>
                    </div>
                </form>
            </div>
        </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/user';
        
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.textContent = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
                themeToggle.title = theme === 'light' ? 'åˆ‡æ¢åˆ°æš—è‰²ä¸»é¢˜' : 'åˆ‡æ¢åˆ°äº®è‰²ä¸»é¢˜';
            }
            
            // æ›´æ–°æ‰€æœ‰å›¾è¡¨ä¸»é¢˜ï¼ˆå¦‚æœå›¾è¡¨å·²åˆ›å»ºï¼‰
            updateChartsTheme(theme);
        }
        
        // è·å–å›¾è¡¨ä¸»é¢˜é…ç½®
        function getChartThemeConfig() {
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const isDark = theme === 'dark';
            
            return {
                backgroundColor: isDark ? '#2d2d2d' : '#ffffff',
                textColor: isDark ? '#b0b0b0' : '#333333',
                gridColor: isDark ? '#404040' : '#e0e0e0',
                borderColor: isDark ? '#404040' : '#e0e0e0'
            };
        }
        
        // æ›´æ–°å›¾è¡¨ä¸»é¢˜
        function updateChartsTheme(theme) {
            try {
                const config = getChartThemeConfig();
                
                // æ›´æ–°æµé‡è¶‹åŠ¿å›¾ï¼ˆä½¿ç”¨windowå¯¹è±¡è®¿é—®ï¼Œé¿å…åˆå§‹åŒ–é”™è¯¯ï¼‰
                if (window.trafficTrendChart) {
                    if (window.trafficTrendChart.options && window.trafficTrendChart.options.plugins) {
                        if (window.trafficTrendChart.options.plugins.legend) {
                            window.trafficTrendChart.options.plugins.legend.labels.color = config.textColor;
                        }
                        if (window.trafficTrendChart.options.plugins.title) {
                            window.trafficTrendChart.options.plugins.title.color = config.textColor;
                        }
                    }
                    if (window.trafficTrendChart.options && window.trafficTrendChart.options.scales) {
                        if (window.trafficTrendChart.options.scales.x) {
                            window.trafficTrendChart.options.scales.x.ticks.color = config.textColor;
                            window.trafficTrendChart.options.scales.x.grid.color = config.gridColor;
                        }
                        if (window.trafficTrendChart.options.scales.y) {
                            window.trafficTrendChart.options.scales.y.ticks.color = config.textColor;
                            window.trafficTrendChart.options.scales.y.grid.color = config.gridColor;
                            if (window.trafficTrendChart.options.scales.y.title) {
                                window.trafficTrendChart.options.scales.y.title.color = config.textColor;
                            }
                        }
                    }
                    window.trafficTrendChart.update();
                }
                
                // æ›´æ–°è®¾å¤‡å¯¹æ¯”å›¾
                if (window.deviceComparisonChart) {
                    if (window.deviceComparisonChart.options && window.deviceComparisonChart.options.plugins) {
                        if (window.deviceComparisonChart.options.plugins.legend) {
                            window.deviceComparisonChart.options.plugins.legend.labels.color = config.textColor;
                        }
                        if (window.deviceComparisonChart.options.plugins.title) {
                            window.deviceComparisonChart.options.plugins.title.color = config.textColor;
                        }
                    }
                    if (window.deviceComparisonChart.options && window.deviceComparisonChart.options.scales) {
                        if (window.deviceComparisonChart.options.scales.x) {
                            window.deviceComparisonChart.options.scales.x.ticks.color = config.textColor;
                            window.deviceComparisonChart.options.scales.x.grid.color = config.gridColor;
                        }
                        if (window.deviceComparisonChart.options.scales.y) {
                            window.deviceComparisonChart.options.scales.y.ticks.color = config.textColor;
                            window.deviceComparisonChart.options.scales.y.grid.color = config.gridColor;
                            if (window.deviceComparisonChart.options.scales.y.title) {
                                window.deviceComparisonChart.options.scales.y.title.color = config.textColor;
                            }
                        }
                    }
                    window.deviceComparisonChart.update();
                }
                
                // æ›´æ–°æµé‡åˆ†å¸ƒå›¾
                if (window.trafficDistributionChart) {
                    if (window.trafficDistributionChart.options && window.trafficDistributionChart.options.plugins && window.trafficDistributionChart.options.plugins.legend) {
                        window.trafficDistributionChart.options.plugins.legend.labels.color = config.textColor;
                    }
                    window.trafficDistributionChart.update();
                }
                
                // æ›´æ–°æ—¶é—´æ®µå¯¹æ¯”å›¾
                if (window.periodComparisonChart) {
                    if (window.periodComparisonChart.options && window.periodComparisonChart.options.plugins) {
                        if (window.periodComparisonChart.options.plugins.legend) {
                            window.periodComparisonChart.options.plugins.legend.labels.color = config.textColor;
                        }
                    }
                    if (window.periodComparisonChart.options && window.periodComparisonChart.options.scales) {
                        if (window.periodComparisonChart.options.scales.x) {
                            window.periodComparisonChart.options.scales.x.ticks.color = config.textColor;
                            window.periodComparisonChart.options.scales.x.grid.color = config.gridColor;
                        }
                        if (window.periodComparisonChart.options.scales.y) {
                            window.periodComparisonChart.options.scales.y.ticks.color = config.textColor;
                            window.periodComparisonChart.options.scales.y.grid.color = config.gridColor;
                        }
                    }
                    window.periodComparisonChart.update();
                }
            } catch (error) {
                // é™é»˜å¤„ç†é”™è¯¯ï¼Œå›¾è¡¨å¯èƒ½è¿˜æœªåˆå§‹åŒ–
                console.debug('æ›´æ–°å›¾è¡¨ä¸»é¢˜æ—¶å‡ºé”™ï¼ˆå›¾è¡¨å¯èƒ½å°šæœªåˆ›å»ºï¼‰:', error);
            }
        }
        
        // åˆå§‹åŒ–ä¸»é¢˜
        initTheme();
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆé¡µé¢åŠ è½½æ—¶é™é»˜æ£€æŸ¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ï¼‰
        checkLoginStatus();
        
        function showMessage(containerId, message, isError = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }
        
        function showLogin() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('userCenter').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('message').innerHTML = '';
        }
        
        function showRegister() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('userCenter').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('register-message').innerHTML = '';
        }
        
        function showUserCenter() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('userCenter').style.display = 'block';
            loadUserInfo();
            // å¼€å§‹åŠ è½½æ´»è·ƒå‘Šè­¦
            updateActiveAlerts();
            // å®šæœŸæ›´æ–°æ´»è·ƒå‘Šè­¦ï¼ˆæ¯30ç§’ï¼‰
            if (!window.activeAlertsInterval) {
                window.activeAlertsInterval = setInterval(updateActiveAlerts, 30000);
            }
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®å¹¶è®¾ç½®ä¸ºactive
            const buttons = document.querySelectorAll('.tab');
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tabName === 'userInfo') {
                document.getElementById('userInfoTab').classList.add('active');
            } else if (tabName === 'dashboard') {
                document.getElementById('dashboardTab').classList.add('active');
                // åˆå§‹åŒ–ä»ªè¡¨ç›˜
                initDashboard();
            } else if (tabName === 'charts') {
                document.getElementById('chartsTab').classList.add('active');
                // åˆå§‹åŒ–å›¾è¡¨é¡µé¢
                initChartsPage();
            } else if (tabName === 'statistics') {
                document.getElementById('statisticsTab').classList.add('active');
                // åˆå§‹åŒ–ç»Ÿè®¡åˆ†æé¡µé¢
                initStatisticsPage();
            } else if (tabName === 'dataManagement') {
                document.getElementById('dataManagementTab').classList.add('active');
                // åˆå§‹åŒ–æ•°æ®ç®¡ç†é¡µé¢
                initDataManagementPage();
            } else if (tabName === 'alerts') {
                document.getElementById('alertsTab').classList.add('active');
                // åˆå§‹åŒ–å‘Šè­¦ç®¡ç†é¡µé¢
                initAlertsPage();
            } else if (tabName === 'dataQuery') {
                document.getElementById('dataQueryTab').classList.add('active');
            } else if (tabName === 'config') {
                document.getElementById('configTab').classList.add('active');
                // åˆå§‹åŒ–é…ç½®ç®¡ç†é¡µé¢
                initConfigPage();
            } else if (tabName === 'userManagement') {
                document.getElementById('userManagementTab').classList.add('active');
                // åˆå§‹åŒ–ç”¨æˆ·ç®¡ç†é¡µé¢
                initUserManagementPage();
            }
        }
        
        // ç™»å½•è¡¨å•æäº¤
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('message', 'ç™»å½•æˆåŠŸï¼', false);
                    setTimeout(() => {
                        showUserCenter();
                    }, 500);
                } else {
                    showMessage('message', data.message || 'ç™»å½•å¤±è´¥', true);
                }
            } catch (error) {
                showMessage('message', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message, true);
            }
        });
        
        // æ³¨å†Œè¡¨å•æäº¤
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('register-message', `æ³¨å†ŒæˆåŠŸï¼æ‚¨çš„ Token: ${data.data.token}`, false);
                    setTimeout(() => {
                        showLogin();
                    }, 2000);
                } else {
                    showMessage('register-message', data.message || 'æ³¨å†Œå¤±è´¥', true);
                }
            } catch (error) {
                showMessage('register-message', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message, true);
            }
        });
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${API_BASE}/info`, {
                    // æ·»åŠ credentialsä»¥æ”¯æŒsession
                    credentials: 'same-origin'
                });
                
                // 401æ˜¯é¢„æœŸçš„ï¼ˆæœªç™»å½•ï¼‰ï¼Œä¸è§†ä¸ºé”™è¯¯
                if (response.status === 401) {
                    // æœªç™»å½•ï¼Œæ­£å¸¸æƒ…å†µï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showUserCenter();
                    }
                }
            } catch (error) {
                // ç½‘ç»œé”™è¯¯ç­‰ï¼Œé™é»˜å¤„ç†ï¼ˆæœªç™»å½•æ˜¯æ­£å¸¸æƒ…å†µï¼‰
                console.debug('Login check (expected if not logged in):', error.message);
            }
        }
        
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰ç”¨æˆ·ä¿¡æ¯
        let currentUserRole = 'user';
        
        // æƒé™ç®¡ç†å‡½æ•°ï¼ˆéœ€è¦åœ¨loadUserInfoä¹‹å‰å®šä¹‰ï¼‰
        function updateUIByRole(role) {
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤º/éšè—ç®¡ç†åŠŸèƒ½æ ‡ç­¾
            const configTabBtn = document.getElementById('configTabBtn');
            const userManagementTabBtn = document.getElementById('userManagementTabBtn');
            
            if (role === 'admin') {
                if (configTabBtn) configTabBtn.style.display = 'inline-block';
                if (userManagementTabBtn) userManagementTabBtn.style.display = 'inline-block';
            } else {
                if (configTabBtn) configTabBtn.style.display = 'none';
                if (userManagementTabBtn) userManagementTabBtn.style.display = 'none';
            }
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/info`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const user = data.data;
                    currentUserRole = user.role || 'user';  // å­˜å‚¨ç”¨æˆ·è§’è‰²
                    
                    // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤º/éšè—åŠŸèƒ½æ ‡ç­¾
                    updateUIByRole(currentUserRole);
                    
                    // è®¾ç½®é¡¶éƒ¨ç”¨æˆ·åå’Œé€€å‡ºæŒ‰é’®
                    document.getElementById('user-info-header').innerHTML = `
                        <span class="username-display">ğŸ‘¤ ${user.username}</span>
                        <button class="btn-secondary logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                    `;
                    
                    document.getElementById('user-info').innerHTML = `
                        <h2>ç”¨æˆ·ä¿¡æ¯</h2>
                        <div class="info-item">
                            <label>ç”¨æˆ·å</label>
                            <div>${user.username}</div>
                        </div>
                        <div class="info-item">
                            <label>è§’è‰²</label>
                            <div>${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</div>
                        </div>
                        <div class="info-item">
                            <label>API Token</label>
                            <div class="token-box" id="token-box">${user.token}</div>
                            <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                                <button class="copy-btn" onclick="copyToken()" style="padding: 8px 16px !important; font-size: 13px !important; width: auto;">å¤åˆ¶ Token</button>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>åˆ›å»ºæ—¶é—´</label>
                            <div>${new Date(user.created_at).toLocaleString('zh-CN')}</div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: var(--card-info-bg); border-radius: 6px;">
                            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                            ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åœ¨ API è¯·æ±‚ä¸­åŒ…å« Tokenï¼š<br>
                            <code style="display: block; margin-top: 10px; padding: 8px; background: var(--bg-primary); border-radius: 4px;">
                                curl -H "X-API-Key: ${user.token}" http://localhost:5000/api/monitor
                            </code>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                <a href="/api/docs" target="_blank" style="color: var(--accent-color); text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 6px;">
                                    <span>ğŸ“š</span>
                                    <span>æŸ¥çœ‹å®Œæ•´çš„äº¤äº’å¼APIæ–‡æ¡£</span>
                                    <span style="font-size: 12px; margin-left: 4px;">â†—</span>
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    showMessage('user-message', data.message || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', true);
                }
            } catch (error) {
                showMessage('user-message', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message, true);
            }
        }
        
        // å¤åˆ¶Token
        function copyToken() {
            const tokenBox = document.getElementById('token-box');
            const token = tokenBox.textContent;
            navigator.clipboard.writeText(token).then(() => {
                alert('Token å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                // å¤‡ç”¨æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = token;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Token å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
        
        // åˆ·æ–°Token
        async function refreshToken() {
            if (!confirm('ç¡®å®šè¦åˆ·æ–° Token å—ï¼Ÿæ—§çš„ Token å°†ç«‹å³å¤±æ•ˆï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/token/refresh`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Token åˆ·æ–°æˆåŠŸï¼');
                    loadUserInfo();
                } else {
                    alert('åˆ·æ–°å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                const response = await fetch(`${API_BASE}/logout`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showLogin();
                }
            } catch (error) {
                console.error('Logout error:', error);
                showLogin();
            }
        }
        
        // ============ æ•°æ®æŸ¥è¯¢åŠŸèƒ½ ============
        let currentPage = 1;
        let currentTable = '';
        let currentDeviceId = '';
        
        // è¡¨é€‰æ‹©å˜åŒ–æ—¶
        document.getElementById('tableSelect').addEventListener('change', function() {
            const table = this.value;
            currentTable = table;
            currentPage = 1;
            currentDeviceId = '';
            
            const deviceSelect = document.getElementById('deviceSelect');
            
            if (table === 'device_traffic') {
                deviceSelect.disabled = false;
                loadDevices();
            } else {
                deviceSelect.disabled = true;
                deviceSelect.innerHTML = '<option value="">-- ä¸é€‚ç”¨ --</option>';
            }
            
            // æ¸…ç©ºæ˜¾ç¤º
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('empty').style.display = 'none';
        });
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch('/api/database/devices');
                const result = await response.json();
                
                const deviceSelect = document.getElementById('deviceSelect');
                deviceSelect.innerHTML = '<option value="">-- å…¨éƒ¨è®¾å¤‡ --</option>';
                
                if (result.success && result.data) {
                    result.data.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.textContent = `${device.hostname || 'æœªçŸ¥'} (${device.mac})`;
                        deviceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ•°æ®
        async function loadData() {
            const table = document.getElementById('tableSelect').value;
            if (!table) {
                alert('è¯·å…ˆé€‰æ‹©è¡¨');
                return;
            }
            
            const deviceSelect = document.getElementById('deviceSelect');
            const deviceId = deviceSelect.value;
            
            currentTable = table;
            currentDeviceId = deviceId;
            currentPage = 1;
            
            await fetchData();
        }
        
        // è·å–æ•°æ®
        async function fetchData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const tableContainer = document.getElementById('tableContainer');
            const statsContainer = document.getElementById('statsContainer');
            const pagination = document.getElementById('pagination');
            const empty = document.getElementById('empty');
            
            // æ˜¾ç¤ºåŠ è½½
            loading.style.display = 'block';
            error.style.display = 'none';
            tableContainer.style.display = 'none';
            statsContainer.style.display = 'none';
            pagination.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                let url = '';
                
                if (currentTable === 'total_traffic') {
                    url = `/api/database/total-traffic?page=${currentPage}&per_page=100`;
                } else if (currentTable === 'device_traffic') {
                    if (!currentDeviceId) {
                        throw new Error('è¯·é€‰æ‹©è®¾å¤‡');
                    }
                    url = `/api/database/device-traffic/${currentDeviceId}?page=${currentPage}&per_page=100`;
                } else if (currentTable === 'devices') {
                    url = `/api/database/devices`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½æ•°æ®å¤±è´¥');
                }
                
                // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
                if (result.pagination) {
                    showStats(result.pagination);
                } else if (result.count !== undefined) {
                    showStats({ total: result.count });
                }
                
                // æ˜¾ç¤ºè¡¨æ ¼
                if (currentTable === 'devices') {
                    displayDevicesTable(result.data || []);
                } else {
                    displayTrafficTable(result.data || []);
                }
                
                // ç¼“å­˜æ•°æ®ç”¨äºå¯¼å‡º
                cacheQueryDataForExport(result.data || [], currentTable);
                
                // æ˜¾ç¤ºåˆ†é¡µ
                if (result.pagination) {
                    displayPagination(result.pagination);
                }
                
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
            }
        }
        
        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        function showStats(pagination) {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="value">${pagination.total || 0}</div>
                    <div class="label">æ€»è®°å½•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="value">${pagination.page || 1}</div>
                    <div class="label">å½“å‰é¡µç </div>
                </div>
                <div class="stat-card">
                    <div class="value">${pagination.pages || 1}</div>
                    <div class="label">æ€»é¡µæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="value">${pagination.per_page || 100}</div>
                    <div class="label">æ¯é¡µè®°å½•æ•°</div>
                </div>
            `;
            statsContainer.style.display = 'grid';
        }
        
        // æ˜¾ç¤ºè®¾å¤‡è¡¨
        function displayDevicesTable(data) {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            const tableContainer = document.getElementById('tableContainer');
            const empty = document.getElementById('empty');
            
            if (data.length === 0) {
                empty.style.display = 'block';
                tableContainer.style.display = 'none';
                return;
            }
            
            tableHead.innerHTML = `
                <tr>
                    <th>ID</th>
                    <th>MACåœ°å€</th>
                    <th>ä¸»æœºå</th>
                    <th>IPåœ°å€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ›´æ–°æ—¶é—´</th>
                </tr>
            `;
            
            tableBody.innerHTML = data.map(device => `
                <tr>
                    <td>${device.id}</td>
                    <td>${device.mac || '-'}</td>
                    <td>${device.hostname || 'æœªçŸ¥'}</td>
                    <td>${device.ip || '-'}</td>
                    <td>${device.created_at ? new Date(device.created_at).toLocaleString('zh-CN') : '-'}</td>
                    <td>${device.updated_at ? new Date(device.updated_at).toLocaleString('zh-CN') : '-'}</td>
                </tr>
            `).join('');
            
            tableContainer.style.display = 'block';
            empty.style.display = 'none';
        }
        
        // æ˜¾ç¤ºæµé‡è¡¨
        function displayTrafficTable(data) {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            const tableContainer = document.getElementById('tableContainer');
            const empty = document.getElementById('empty');
            
            if (data.length === 0) {
                empty.style.display = 'block';
                tableContainer.style.display = 'none';
                return;
            }
            
            tableHead.innerHTML = `
                <tr>
                    <th>ID</th>
                    ${currentTable === 'device_traffic' ? '<th>è®¾å¤‡ID</th>' : ''}
                    <th>æ—¶é—´æˆ³</th>
                    <th>ä¸‹è¡Œé€Ÿç‡</th>
                    <th>ä¸Šè¡Œé€Ÿç‡</th>
                    <th>ç´¯è®¡ä¸‹è½½</th>
                    <th>ç´¯è®¡ä¸Šä¼ </th>
                </tr>
            `;
            
            tableBody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.id}</td>
                    ${currentTable === 'device_traffic' ? `<td>${item.device_id}</td>` : ''}
                    <td>${item.timestamp ? new Date(item.timestamp).toLocaleString('zh-CN') : '-'}</td>
                    <td>${item.down_speed?.formatted || item.down_speed?.bytes || '-'}</td>
                    <td>${item.up_speed?.formatted || item.up_speed?.bytes || '-'}</td>
                    <td>${item.total_download?.formatted || item.total_download?.bytes || '-'}</td>
                    <td>${item.total_upload?.formatted || item.total_upload?.bytes || '-'}</td>
                </tr>
            `).join('');
            
            tableContainer.style.display = 'block';
            empty.style.display = 'none';
        }
        
        // æ˜¾ç¤ºåˆ†é¡µ
        function displayPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            
            if (!pagination || pagination.pages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.innerHTML = `
                <button onclick="goToPage(1)" ${!pagination.has_prev ? 'disabled' : ''}>é¦–é¡µ</button>
                <button onclick="goToPage(${currentPage - 1})" ${!pagination.has_prev ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                <span class="page-info">ç¬¬ ${pagination.page} / ${pagination.pages} é¡µ (å…± ${pagination.total} æ¡)</span>
                <button onclick="goToPage(${currentPage + 1})" ${!pagination.has_next ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                <button onclick="goToPage(${pagination.pages})" ${!pagination.has_next ? 'disabled' : ''}>æœ«é¡µ</button>
            `;
            
            paginationDiv.style.display = 'flex';
        }
        
        // è·³è½¬é¡µé¢
        function goToPage(page) {
            currentPage = page;
            fetchData();
        }
        
        // ============ æ•°æ®å¯¼å‡ºåŠŸèƒ½ ============
        // ç¼“å­˜å½“å‰æŸ¥è¯¢ç»“æœæ•°æ®ï¼ˆç”¨äºå¯¼å‡ºï¼‰
        let currentQueryData = [];
        let currentQueryHeaders = [];
        let currentQueryTableType = '';
        
        // ç¼“å­˜æŸ¥è¯¢æ•°æ®ç”¨äºå¯¼å‡º
        function cacheQueryDataForExport(data, tableType) {
            currentQueryData = [];
            currentQueryTableType = tableType;
            
            if (!data || data.length === 0) {
                currentQueryHeaders = [];
                return;
            }
            
            if (tableType === 'devices') {
                // è®¾å¤‡è¡¨
                currentQueryHeaders = ['ID', 'MACåœ°å€', 'è®¾å¤‡åç§°', 'IPåœ°å€', 'åˆ›å»ºæ—¶é—´', 'æ›´æ–°æ—¶é—´'];
                currentQueryData = data.map(device => [
                    device.id || '',
                    device.mac || '',
                    device.hostname || 'æœªçŸ¥',
                    device.ip || '-',
                    device.created_at ? new Date(device.created_at).toLocaleString('zh-CN') : '-',
                    device.updated_at ? new Date(device.updated_at).toLocaleString('zh-CN') : '-'
                ]);
            } else if (tableType === 'total_traffic') {
                // å…¨ç½‘æµé‡è¡¨
                currentQueryHeaders = ['ID', 'æ—¶é—´æˆ³', 'ä¸‹è¡Œé€Ÿç‡', 'ä¸Šè¡Œé€Ÿç‡', 'æ€»ä¸‹è½½', 'æ€»ä¸Šä¼ '];
                currentQueryData = data.map(record => {
                    const downSpeed = record.down_speed?.formatted || record.down_speed?.bytes + ' bytes' || '-';
                    const upSpeed = record.up_speed?.formatted || record.up_speed?.bytes + ' bytes' || '-';
                    const totalDownload = record.total_download?.formatted || record.total_download?.bytes + ' bytes' || '-';
                    const totalUpload = record.total_upload?.formatted || record.total_upload?.bytes + ' bytes' || '-';
                    
                    return [
                        record.id || '',
                        record.timestamp ? new Date(record.timestamp).toLocaleString('zh-CN') : '-',
                        downSpeed,
                        upSpeed,
                        totalDownload,
                        totalUpload
                    ];
                });
            } else if (tableType === 'device_traffic') {
                // è®¾å¤‡æµé‡è¡¨
                currentQueryHeaders = ['ID', 'è®¾å¤‡ID', 'æ—¶é—´æˆ³', 'ä¸‹è¡Œé€Ÿç‡', 'ä¸Šè¡Œé€Ÿç‡', 'æ€»ä¸‹è½½', 'æ€»ä¸Šä¼ '];
                currentQueryData = data.map(record => {
                    const downSpeed = record.down_speed?.formatted || record.down_speed?.bytes + ' bytes' || '-';
                    const upSpeed = record.up_speed?.formatted || record.up_speed?.bytes + ' bytes' || '-';
                    const totalDownload = record.total_download?.formatted || record.total_download?.bytes + ' bytes' || '-';
                    const totalUpload = record.total_upload?.formatted || record.total_upload?.bytes + ' bytes' || '-';
                    
                    return [
                        record.id || '',
                        record.device_id || '',
                        record.timestamp ? new Date(record.timestamp).toLocaleString('zh-CN') : '-',
                        downSpeed,
                        upSpeed,
                        totalDownload,
                        totalUpload
                    ];
                });
            }
        }
        
        // å¯¼å‡ºCSV
        function exportToCSV() {
            if (!currentTable || currentQueryData.length === 0) {
                alert('è¯·å…ˆæŸ¥è¯¢æ•°æ®');
                return;
            }
            
            try {
                // å‡†å¤‡CSVå†…å®¹
                let csvContent = '\uFEFF'; // UTF-8 BOMï¼Œæ”¯æŒExcelæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡
                
                // æ·»åŠ è¡¨å¤´
                csvContent += currentQueryHeaders.join(',') + '\n';
                
                // æ·»åŠ æ•°æ®è¡Œ
                currentQueryData.forEach(row => {
                    const csvRow = row.map(cell => {
                        // å¤„ç†åŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œç¬¦çš„å­—æ®µ
                        if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n'))) {
                            return '"' + cell.replace(/"/g, '""') + '"';
                        }
                        return cell || '';
                    });
                    csvContent += csvRow.join(',') + '\n';
                });
                
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `bandix_data_${currentTable}_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
            } catch (err) {
                alert('å¯¼å‡ºCSVå¤±è´¥: ' + err.message);
                console.error('CSVå¯¼å‡ºé”™è¯¯:', err);
            }
        }
        
        // å¯¼å‡ºExcel
        function exportToExcel() {
            if (!currentTable || currentQueryData.length === 0) {
                alert('è¯·å…ˆæŸ¥è¯¢æ•°æ®');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½xlsxåº“
            if (typeof XLSX === 'undefined') {
                alert('Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦åŠ è½½xlsxåº“ï¼Œè¯·ç¨å€™é‡è¯•');
                return;
            }
            
            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                // å‡†å¤‡æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
                const wsData = [currentQueryHeaders, ...currentQueryData];
                
                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // è®¾ç½®åˆ—å®½ï¼ˆå¯é€‰ï¼‰
                const colWidths = currentQueryHeaders.map(() => ({ wch: 15 }));
                ws['!cols'] = colWidths;
                
                // å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿
                const sheetName = currentTable.length > 31 ? currentTable.substring(0, 31) : currentTable; // Excelå·¥ä½œè¡¨åç§°æœ€å¤š31ä¸ªå­—ç¬¦
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = `bandix_data_${currentTable}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                
                // ä¸‹è½½æ–‡ä»¶
                XLSX.writeFile(wb, fileName);
            } catch (err) {
                alert('å¯¼å‡ºExcelå¤±è´¥: ' + err.message);
                console.error('Excelå¯¼å‡ºé”™è¯¯:', err);
            }
        }
        
        // ============ ç»Ÿè®¡åˆ†æåŠŸèƒ½ ============
        window.trafficDistributionChart = null;
        window.periodComparisonChart = null;
        
        // åˆå§‹åŒ–ç»Ÿè®¡åˆ†æé¡µé¢
        async function initStatisticsPage() {
            await loadStatisticsData();
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatisticsData() {
            const error = document.getElementById('statisticsError');
            error.style.display = 'none';
            
            try {
                const response = await fetch('/api/database/stats');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½æ•°æ®å¤±è´¥');
                }
                
                const data = result.data;
                
                // æ¸²æŸ“æµé‡ç»Ÿè®¡æ±‡æ€»
                if (data.traffic_summary) {
                    renderTrafficSummary(data.traffic_summary);
                }
                
                // æ¸²æŸ“é€Ÿç‡ç»Ÿè®¡
                if (data.speed_stats) {
                    renderSpeedStats(data.speed_stats);
                }
                
                // æ¸²æŸ“è®¾å¤‡æ’å
                if (data.device_stats && data.device_stats.ranking) {
                    renderDeviceRanking(data.device_stats.ranking);
                }
                
                // æ¸²æŸ“è®¾å¤‡æµé‡å æ¯”
                if (data.device_stats && data.device_stats.traffic_distribution) {
                    renderTrafficDistribution(data.device_stats.traffic_distribution);
                }
                
                // æ¸²æŸ“æ—¶é—´æ®µå¯¹æ¯”
                if (data.comparison) {
                    renderPeriodComparison(data.comparison);
                }
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', err);
            }
        }
        
        // æ¸²æŸ“æµé‡ç»Ÿè®¡æ±‡æ€»
        function renderTrafficSummary(summary) {
            // ä»Šæ—¥
            if (summary.today) {
                document.getElementById('todayDownload').textContent = summary.today.total_download_formatted || '0 B';
                document.getElementById('todayDownloadFormatted').textContent = '';
                
                document.getElementById('todayUpload').textContent = summary.today.total_upload_formatted || '0 B';
                document.getElementById('todayUploadFormatted').textContent = '';
            }
            
            // æœ¬å‘¨
            if (summary.this_week) {
                document.getElementById('weekDownload').textContent = summary.this_week.total_download_formatted || '0 B';
                document.getElementById('weekDownloadFormatted').textContent = '';
                
                document.getElementById('weekUpload').textContent = summary.this_week.total_upload_formatted || '0 B';
                document.getElementById('weekUploadFormatted').textContent = '';
            }
            
            // æœ¬æœˆ
            if (summary.this_month) {
                document.getElementById('monthDownload').textContent = summary.this_month.total_download_formatted || '0 B';
                document.getElementById('monthDownloadFormatted').textContent = '';
                
                document.getElementById('monthUpload').textContent = summary.this_month.total_upload_formatted || '0 B';
                document.getElementById('monthUploadFormatted').textContent = '';
            }
        }
        
        // æ¸²æŸ“é€Ÿç‡ç»Ÿè®¡
        function renderSpeedStats(stats) {
            // å¹³å‡ä¸‹è¡Œé€Ÿç‡
            document.getElementById('avgDownSpeed').textContent = stats.avg_down_speed_formatted || '0 B/s';
            document.getElementById('avgDownSpeedFormatted').textContent = '';
            
            // å¹³å‡ä¸Šè¡Œé€Ÿç‡
            document.getElementById('avgUpSpeed').textContent = stats.avg_up_speed_formatted || '0 B/s';
            document.getElementById('avgUpSpeedFormatted').textContent = '';
            
            // å³°å€¼ä¸‹è¡Œé€Ÿç‡
            document.getElementById('peakDownSpeed').textContent = stats.peak_down_speed_formatted || '0 B/s';
            document.getElementById('peakDownSpeedFormatted').textContent = '';
            
            // å³°å€¼ä¸Šè¡Œé€Ÿç‡
            document.getElementById('peakUpSpeed').textContent = stats.peak_up_speed_formatted || '0 B/s';
            document.getElementById('peakUpSpeedFormatted').textContent = '';
        }
        
        // æ¸²æŸ“è®¾å¤‡æ’åè¡¨æ ¼
        function renderDeviceRanking(ranking) {
            const tableBody = document.getElementById('statisticsDeviceRankingTableBody');
            
            if (!ranking || ranking.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            tableBody.innerHTML = ranking.map((device, index) => {
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${device.device_name || 'æœªçŸ¥'}</td>
                        <td>${device.mac || '-'}</td>
                        <td>${device.ip || '-'}</td>
                        <td>${device.total_download_formatted || '-'}</td>
                        <td>${device.total_upload_formatted || '-'}</td>
                        <td>${device.total_traffic_formatted || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ¸²æŸ“è®¾å¤‡æµé‡å æ¯”é¥¼å›¾
        function renderTrafficDistribution(distribution) {
            const ctx = document.getElementById('trafficDistributionChart');
            if (!ctx) return;
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (window.trafficDistributionChart) {
                window.trafficDistributionChart.destroy();
            }
            
            if (!distribution || distribution.length === 0) {
                return;
            }
            
            // å‡†å¤‡æ•°æ®
            const labels = distribution.map(d => d.device_name || d.mac);
            const data = distribution.map(d => d.total_traffic_bytes);
            const colors = generateColors(distribution.length);
            
            const chartTheme = getChartThemeConfig();
            window.trafficDistributionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                },
                                color: chartTheme.textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const item = distribution[context.dataIndex];
                                    const percentage = item.percentage || 0;
                                    return `${label}: ${item.total_traffic_formatted} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // æ¸²æŸ“æ—¶é—´æ®µå¯¹æ¯”å›¾è¡¨
        function renderPeriodComparison(comparison) {
            const ctx = document.getElementById('periodComparisonChart');
            if (!ctx) return;
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (window.periodComparisonChart) {
                window.periodComparisonChart.destroy();
            }
            
            // å‡†å¤‡æ•°æ®
            const labels = [];
            const currentData = [];
            const previousData = [];
            const growthRates = [];
            
            if (comparison.day_over_day) {
                labels.push('æ—¥å¯¹æ¯”');
                currentData.push(comparison.day_over_day.current.total_traffic_bytes);
                previousData.push(comparison.day_over_day.previous.total_traffic_bytes);
                growthRates.push(comparison.day_over_day.growth_formatted);
            }
            
            if (comparison.week_over_week) {
                labels.push('å‘¨å¯¹æ¯”');
                currentData.push(comparison.week_over_week.current.total_traffic_bytes);
                previousData.push(comparison.week_over_week.previous.total_traffic_bytes);
                growthRates.push(comparison.week_over_week.growth_formatted);
            }
            
            if (comparison.month_over_month) {
                labels.push('æœˆå¯¹æ¯”');
                currentData.push(comparison.month_over_month.current.total_traffic_bytes);
                previousData.push(comparison.month_over_month.previous.total_traffic_bytes);
                growthRates.push(comparison.month_over_month.growth_formatted);
            }
            
            if (labels.length === 0) {
                return;
            }
            
            const chartTheme2 = getChartThemeConfig();
            window.periodComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å½“å‰',
                            data: currentData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ä¸Šä¸€æœŸ',
                            data: previousData,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: chartTheme2.textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y || 0;
                                    return `${label}: ${formatBytes(value)}`;
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const index = context.dataIndex;
                                        return `å¢é•¿ç‡: ${growthRates[index]}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: chartTheme2.textColor
                            },
                            grid: {
                                color: chartTheme2.gridColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatBytes(value);
                                },
                                color: chartTheme2.textColor
                            },
                            grid: {
                                color: chartTheme2.gridColor
                            }
                        }
                    }
                }
            });
        }
        
        // ç”Ÿæˆé¢œè‰²æ•°ç»„
        function generateColors(count) {
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }
        
        // æ ¼å¼åŒ–å­—èŠ‚æ•°ï¼ˆç”¨äºå›¾è¡¨ï¼‰
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ============ ç”¨æˆ·ç®¡ç†åŠŸèƒ½ ============
        
        let userManagementPage = 1;
        let userManagementPerPage = 20;
        
        async function initUserManagementPage() {
            await loadUserList();
        }
        
        async function loadUserList(page = 1) {
            const loading = document.getElementById('userManagementLoading');
            const error = document.getElementById('userManagementError');
            const content = document.getElementById('userManagementContent');
            const tableBody = document.getElementById('userListTableBody');
            
            loading.style.display = 'flex';
            error.style.display = 'none';
            content.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/list?page=${page}&per_page=${userManagementPerPage}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('éœ€è¦ç®¡ç†å‘˜æƒé™');
                    }
                    throw new Error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
                }
                
                const data = result.data;
                userManagementPage = data.page;
                
                // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
                tableBody.innerHTML = '';
                data.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${escapeHtml(user.username)}</td>
                                <td>${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</td>
                                <td>${user.is_active ? '<span style="color: var(--success-color);">å¯ç”¨</span>' : '<span style="color: var(--error-text);">ç¦ç”¨</span>'}</td>
                                <td>${user.created_at ? new Date(user.created_at).toLocaleString('zh-CN') : '-'}</td>
                                <td style="white-space: nowrap; text-align: left;">
                                    <button class="btn-secondary" onclick="editUser(${user.id})" style="padding: 5px 8px; margin-right: 4px; font-size: 12px; min-width: auto;">ç¼–è¾‘</button>
                                    <button class="btn-secondary" onclick="toggleUser(${user.id}, ${user.is_active})" style="padding: 5px 8px; margin-right: 4px; font-size: 12px; min-width: auto;">${user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                                    <button class="btn-secondary" onclick="deleteUser(${user.id})" style="padding: 5px 8px; background: var(--error-text); color: white; font-size: 12px; min-width: auto;">åˆ é™¤</button>
                                </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // æ¸²æŸ“åˆ†é¡µ
                renderUserManagementPagination(data.page, data.pages, data.total);
                
                content.style.display = 'block';
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function renderUserManagementPagination(currentPage, totalPages, total) {
            const pagination = document.getElementById('userManagementPagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = `<div style="display: flex; justify-content: space-between; align-items: center;">`;
            html += `<div>å…± ${total} ä¸ªç”¨æˆ·ï¼Œç¬¬ ${currentPage}/${totalPages} é¡µ</div>`;
            html += `<div style="display: flex; gap: 10px;">`;
            
            if (currentPage > 1) {
                html += `<button class="btn-secondary" onclick="loadUserList(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }
            
            // æ˜¾ç¤ºé¡µç 
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                html += `<button class="btn-secondary" onclick="loadUserList(1)">1</button>`;
                if (startPage > 2) html += `<span>...</span>`;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<button class="btn-query" style="cursor: default;">${i}</button>`;
                } else {
                    html += `<button class="btn-secondary" onclick="loadUserList(${i})">${i}</button>`;
                }
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += `<span>...</span>`;
                html += `<button class="btn-secondary" onclick="loadUserList(${totalPages})">${totalPages}</button>`;
            }
            
            if (currentPage < totalPages) {
                html += `<button class="btn-secondary" onclick="loadUserList(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }
            
            html += `</div></div>`;
            pagination.innerHTML = html;
        }
        
        async function editUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/${userId}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                const user = result.data;
                
                // å¡«å……è¡¨å•
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editUsername').disabled = true;  // ç”¨æˆ·åä¸å¯ä¿®æ”¹
                document.getElementById('editPasswordGroup').style.display = 'block';
                document.getElementById('editPassword').required = false;
                document.getElementById('editRole').value = user.role;
                document.getElementById('editIsActive').checked = user.is_active;
                document.getElementById('userEditModalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
                
                // æ˜¾ç¤ºå¯¹è¯æ¡†
                document.getElementById('userEditModal').style.display = 'flex';
                
            } catch (err) {
                document.getElementById('userManagementError').style.display = 'block';
                document.getElementById('userManagementError').textContent = 'é”™è¯¯: ' + err.message;
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
            }
        }
        
        function showCreateUserDialog() {
            // æ¸…ç©ºè¡¨å•
            document.getElementById('editUserId').value = '';
            document.getElementById('editUsername').value = '';
            document.getElementById('editUsername').disabled = false;
            document.getElementById('editPasswordGroup').style.display = 'block';
            document.getElementById('editPassword').value = '';
            document.getElementById('editPassword').required = true;
            document.getElementById('editRole').value = 'user';
            document.getElementById('editIsActive').checked = true;
            document.getElementById('userEditModalTitle').textContent = 'åˆ›å»ºæ–°ç”¨æˆ·';
            
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            document.getElementById('userEditModal').style.display = 'flex';
        }
        
        function closeUserEditModal() {
            document.getElementById('userEditModal').style.display = 'none';
            document.getElementById('userEditForm').reset();
        }
        
        async function saveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const username = document.getElementById('editUsername').value.trim();
            const password = document.getElementById('editPassword').value;
            const role = document.getElementById('editRole').value;
            const isActive = document.getElementById('editIsActive').checked;
            
            // éªŒè¯
            if (!username) {
                alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (!userId && !password) {
                alert('åˆ›å»ºç”¨æˆ·æ—¶å¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                let response;
                let url;
                let method;
                let body = {
                    role: role,
                    is_active: isActive
                };
                
                if (userId) {
                    // æ›´æ–°ç”¨æˆ·
                    url = `${API_BASE}/${userId}`;
                    method = 'PUT';
                    if (password) {
                        body.password = password;
                    }
                } else {
                    // åˆ›å»ºç”¨æˆ·
                    url = `${API_BASE}/register`;
                    method = 'POST';
                    body.username = username;
                    body.password = password;
                }
                
                response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('userManagementSuccess').style.display = 'block';
                    document.getElementById('userManagementSuccess').textContent = userId ? 'ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ' : 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ';
                    closeUserEditModal();
                    await loadUserList(userManagementPage);
                    
                    // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        document.getElementById('userManagementSuccess').style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.message || (userId ? 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥' : 'åˆ›å»ºç”¨æˆ·å¤±è´¥'));
                }
                
            } catch (err) {
                document.getElementById('userManagementError').style.display = 'block';
                document.getElementById('userManagementError').textContent = 'é”™è¯¯: ' + err.message;
                console.error('ä¿å­˜ç”¨æˆ·å¤±è´¥:', err);
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/${userId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('userManagementSuccess').style.display = 'block';
                    document.getElementById('userManagementSuccess').textContent = 'ç”¨æˆ·å·²åˆ é™¤';
                    await loadUserList(userManagementPage);
                    
                    // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        document.getElementById('userManagementSuccess').style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'åˆ é™¤ç”¨æˆ·å¤±è´¥');
                }
                
            } catch (err) {
                document.getElementById('userManagementError').style.display = 'block';
                document.getElementById('userManagementError').textContent = 'é”™è¯¯: ' + err.message;
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', err);
            }
        }
        
        async function toggleUser(userId, currentStatus) {
            if (!confirm(`ç¡®å®šè¦${currentStatus ? 'ç¦ç”¨' : 'å¯ç”¨'}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/${userId}/toggle`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('userManagementSuccess').style.display = 'block';
                    document.getElementById('userManagementSuccess').textContent = result.message || 'æ“ä½œæˆåŠŸ';
                    await loadUserList(userManagementPage);
                } else {
                    throw new Error(result.message || 'æ“ä½œå¤±è´¥');
                }
                
            } catch (err) {
                document.getElementById('userManagementError').style.display = 'block';
                document.getElementById('userManagementError').textContent = 'é”™è¯¯: ' + err.message;
                console.error('åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥:', err);
            }
        }
        
        // ============ é…ç½®ç®¡ç†åŠŸèƒ½ ============
        
        // åˆå§‹åŒ–é…ç½®ç®¡ç†é¡µé¢
        async function initConfigPage() {
            await loadConfig();
            await loadCollectorStatus();
        }
        
        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                document.getElementById('configLoading').style.display = 'flex';
                document.getElementById('configForm').style.display = 'none';
                document.getElementById('configError').style.display = 'none';
                document.getElementById('configSuccess').style.display = 'none';
                
                const response = await fetch('/api/config', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('åŠ è½½é…ç½®å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const config = result.data;
                    
                    // å¡«å……è¡¨å•
                    if (config.bandix) {
                        document.getElementById('bandixUrl').value = config.bandix.url || '';
                        document.getElementById('bandixUsername').value = config.bandix.username || '';
                        // å¯†ç å­—æ®µä¸å¡«å……ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                    }
                    
                    if (config.api) {
                        document.getElementById('apiHost').value = config.api.host || '';
                        document.getElementById('apiPort').value = config.api.port || '';
                        document.getElementById('apiDebug').value = (config.api.debug || 'false').toLowerCase();
                        document.getElementById('apiAuthEnabled').value = (config.api.auth_enabled || 'true').toLowerCase();
                        document.getElementById('apiKey').value = '';
                        document.getElementById('healthCheckRequireAuth').value = (config.api.health_check_require_auth || 'false').toLowerCase();
                    }
                    
                    if (config.collector) {
                        document.getElementById('collectInterval').value = config.collector.collect_interval || '1.0';
                    }
                    
                    document.getElementById('configLoading').style.display = 'none';
                    document.getElementById('configForm').style.display = 'block';
                } else {
                    throw new Error(result.error || 'åŠ è½½é…ç½®å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('configLoading').style.display = 'none';
                document.getElementById('configError').style.display = 'block';
                document.getElementById('configError').textContent = 'åŠ è½½é…ç½®å¤±è´¥: ' + error.message;
            }
        }
        
        // åŠ è½½æ•°æ®æ”¶é›†æœåŠ¡çŠ¶æ€
        async function loadCollectorStatus() {
            try {
                const response = await fetch('/api/config/collector', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const statusText = result.data.is_running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                        document.getElementById('collectorStatusText').textContent = statusText + ` (é—´éš”: ${result.data.collect_interval}ç§’)`;
                    }
                }
            } catch (error) {
                console.debug('åŠ è½½æ”¶é›†æœåŠ¡çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // ä¿å­˜é…ç½®
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // æ”¶é›†è¡¨å•æ•°æ®
                const formData = {
                    bandix: {},
                    api: {},
                    collector: {}
                };
                
                // æ”¶é›†bandixé…ç½®
                const bandixUrl = document.getElementById('bandixUrl').value.trim();
                const bandixUsername = document.getElementById('bandixUsername').value.trim();
                const bandixPassword = document.getElementById('bandixPassword').value.trim();
                
                if (bandixUrl) formData.bandix.url = bandixUrl;
                if (bandixUsername) formData.bandix.username = bandixUsername;
                if (bandixPassword) formData.bandix.password = bandixPassword;
                
                // æ”¶é›†apié…ç½®
                const apiHost = document.getElementById('apiHost').value.trim();
                const apiPort = document.getElementById('apiPort').value.trim();
                const apiDebug = document.getElementById('apiDebug').value;
                const apiAuthEnabled = document.getElementById('apiAuthEnabled').value;
                const apiKey = document.getElementById('apiKey').value.trim();
                const healthCheckRequireAuth = document.getElementById('healthCheckRequireAuth').value;
                
                if (apiHost) formData.api.host = apiHost;
                if (apiPort) formData.api.port = parseInt(apiPort);
                if (apiDebug) formData.api.debug = apiDebug;
                if (apiAuthEnabled) formData.api.auth_enabled = apiAuthEnabled;
                if (apiKey) formData.api.api_key = apiKey;
                if (healthCheckRequireAuth) formData.api.health_check_require_auth = healthCheckRequireAuth;
                
                // æ”¶é›†collectoré…ç½®
                const collectInterval = document.getElementById('collectInterval').value.trim();
                if (collectInterval) formData.collector.collect_interval = parseFloat(collectInterval);
                
                // ç¡®è®¤ä¿å­˜
                const confirmMsg = 'ç¡®å®šè¦ä¿å­˜é…ç½®å—ï¼Ÿ\n\næ³¨æ„ï¼šä¿®æ”¹ç«¯å£æˆ–ä¸»æœºåœ°å€éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚';
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // å‘é€è¯·æ±‚
                document.getElementById('configError').style.display = 'none';
                document.getElementById('configSuccess').style.display = 'none';
                
                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('configSuccess').style.display = 'block';
                    document.getElementById('configSuccess').textContent = result.message || 'é…ç½®å·²ä¿å­˜';
                    
                    // é‡æ–°åŠ è½½é…ç½®å’ŒçŠ¶æ€
                    await loadConfig();
                    await loadCollectorStatus();
                    
                    // æ¸…ç©ºå¯†ç å’ŒAPIå¯†é’¥å­—æ®µ
                    document.getElementById('bandixPassword').value = '';
                    document.getElementById('apiKey').value = '';
                    
                    // å¦‚æœæç¤ºéœ€è¦é‡å¯ï¼Œæ˜¾ç¤ºè­¦å‘Š
                    if (result.requires_restart) {
                        setTimeout(() => {
                            alert('âš ï¸ é…ç½®å·²ä¿å­˜ï¼Œä½†ä¿®æ”¹äº†ç«¯å£æˆ–ä¸»æœºåœ°å€ï¼Œéœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼');
                        }, 500);
                    }
                } else {
                    document.getElementById('configError').style.display = 'block';
                    document.getElementById('configError').textContent = 'ä¿å­˜é…ç½®å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                document.getElementById('configError').style.display = 'block';
                document.getElementById('configError').textContent = 'ä¿å­˜é…ç½®å¤±è´¥: ' + error.message;
            }
        });
        
        // ============ å‘Šè­¦ç®¡ç†åŠŸèƒ½ ============
        
        let alertHistoryPage = 1;
        let alertHistoryPerPage = 20;
        
        // åˆå§‹åŒ–å‘Šè­¦ç®¡ç†é¡µé¢
        async function initAlertsPage() {
            await loadAlertRules();
            await loadAlertHistory();
            await loadDevicesForRules();
        }
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨ï¼ˆç”¨äºè§„åˆ™è¡¨å•ï¼‰
        async function loadDevicesForRules() {
            try {
                const response = await fetch('/api/database/devices');
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('ruleDeviceId');
                    // ä¿ç•™"æ‰€æœ‰è®¾å¤‡"é€‰é¡¹ï¼Œç„¶åæ·»åŠ è®¾å¤‡åˆ—è¡¨
                    select.innerHTML = '<option value="">æ‰€æœ‰è®¾å¤‡ï¼ˆå…¨ç½‘æµé‡ï¼‰</option>';
                    result.data.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.textContent = device.hostname || device.mac || `è®¾å¤‡ ${device.id}`;
                        select.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', err);
            }
        }
        
        // åŠ è½½å‘Šè­¦è§„åˆ™åˆ—è¡¨
        async function loadAlertRules() {
            const error = document.getElementById('alertsError');
            error.style.display = 'none';
            
            try {
                const response = await fetch('/api/alerts/rules', {
                    credentials: 'same-origin'
                });
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½è§„åˆ™å¤±è´¥');
                }
                
                const tbody = document.getElementById('rulesTableBody');
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">æš‚æ— å‘Šè­¦è§„åˆ™ï¼Œç‚¹å‡»"æ–°å»ºè§„åˆ™"åˆ›å»º</td></tr>';
                    return;
                }
                
                tbody.innerHTML = result.data.map(rule => {
                    let thresholdText = '-';
                    if (rule.type === 'traffic_threshold') {
                        thresholdText = formatBytes(rule.threshold_bytes) + '/s';
                        if (rule.device_id) {
                            thresholdText += ' (æŒ‡å®šè®¾å¤‡)';
                        } else {
                            thresholdText += ' (å…¨ç½‘)';
                        }
                    } else if (rule.type === 'device_offline') {
                        thresholdText = rule.offline_threshold_minutes + ' åˆ†é’Ÿ';
                    }
                    
                    const typeText = rule.type === 'traffic_threshold' ? 'æµé‡é˜ˆå€¼' : 'è®¾å¤‡ç¦»çº¿';
                    const severityColors = {
                        'critical': '#dc3545',
                        'warning': '#ffc107',
                        'info': '#17a2b8'
                    };
                    const severityTexts = {
                        'critical': 'ä¸¥é‡',
                        'warning': 'è­¦å‘Š',
                        'info': 'ä¿¡æ¯'
                    };
                    
                    return `
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${escapeHtml(rule.name)}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${typeText}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${thresholdText}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                <span style="color: ${severityColors[rule.severity] || '#666'}; font-weight: 500;">
                                    ${severityTexts[rule.severity] || rule.severity}
                                </span>
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="padding: 4px 8px; border-radius: 4px; background: ${rule.enabled ? '#d4edda' : '#f8d7da'}; color: ${rule.enabled ? '#155724' : '#721c24'};">
                                    ${rule.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                </span>
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                                <button onclick="editRule(${rule.id})" style="padding: 5px 10px; margin-right: 5px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer;">ç¼–è¾‘</button>
                                <button onclick="deleteRule(${rule.id})" style="padding: 5px 10px; border: 1px solid #ddd; background: white; color: #dc3545; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
                console.error('åŠ è½½å‘Šè­¦è§„åˆ™å¤±è´¥:', err);
            }
        }
        
        // æ˜¾ç¤ºæ–°å»ºè§„åˆ™è¡¨å•
        function showCreateRuleForm() {
            document.getElementById('ruleId').value = '';
            document.getElementById('ruleFormTitle').textContent = 'æ–°å»ºå‘Šè­¦è§„åˆ™';
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleEnabled').checked = true;
            updateRuleForm();
            document.getElementById('ruleFormModal').style.display = 'flex';
        }
        
        // ç¼–è¾‘è§„åˆ™
        async function editRule(ruleId) {
            try {
                const response = await fetch(`/api/alerts/rules/${ruleId}`, {
                    credentials: 'same-origin'
                });
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½è§„åˆ™å¤±è´¥');
                }
                
                const rule = result.data;
                document.getElementById('ruleId').value = rule.id;
                document.getElementById('ruleFormTitle').textContent = 'ç¼–è¾‘å‘Šè­¦è§„åˆ™';
                document.getElementById('ruleName').value = rule.name;
                document.getElementById('ruleType').value = rule.type;
                document.getElementById('ruleSeverity').value = rule.severity;
                document.getElementById('ruleEnabled').checked = rule.enabled;
                
                if (rule.type === 'traffic_threshold') {
                    document.getElementById('thresholdBytes').value = rule.threshold_bytes || '';
                    document.getElementById('ruleDeviceId').value = rule.device_id || '';
                } else if (rule.type === 'device_offline') {
                    document.getElementById('offlineThresholdMinutes').value = rule.offline_threshold_minutes || '';
                }
                
                await loadDevicesForRules();
                if (rule.device_id) {
                    setTimeout(() => {
                        document.getElementById('ruleDeviceId').value = rule.device_id;
                    }, 100);
                }
                
                updateRuleForm();
                document.getElementById('ruleFormModal').style.display = 'flex';
                
            } catch (err) {
                alert('åŠ è½½è§„åˆ™å¤±è´¥: ' + err.message);
                console.error('åŠ è½½è§„åˆ™å¤±è´¥:', err);
            }
        }
        
        // æ›´æ–°è§„åˆ™è¡¨å•æ˜¾ç¤º
        function updateRuleForm() {
            const ruleType = document.getElementById('ruleType').value;
            const trafficFields = document.getElementById('trafficThresholdFields');
            const offlineFields = document.getElementById('offlineThresholdFields');
            
            if (ruleType === 'traffic_threshold') {
                trafficFields.style.display = 'block';
                offlineFields.style.display = 'none';
                document.getElementById('thresholdBytes').required = true;
                document.getElementById('offlineThresholdMinutes').required = false;
            } else if (ruleType === 'device_offline') {
                trafficFields.style.display = 'none';
                offlineFields.style.display = 'block';
                document.getElementById('thresholdBytes').required = false;
                document.getElementById('offlineThresholdMinutes').required = true;
            } else {
                trafficFields.style.display = 'none';
                offlineFields.style.display = 'none';
                document.getElementById('thresholdBytes').required = false;
                document.getElementById('offlineThresholdMinutes').required = false;
            }
        }
        
        // ä¿å­˜è§„åˆ™
        async function saveRule(event) {
            event.preventDefault();
            
            const ruleId = document.getElementById('ruleId').value;
            const ruleType = document.getElementById('ruleType').value;
            const error = document.getElementById('alertsError');
            const success = document.getElementById('alertsSuccess');
            
            error.style.display = 'none';
            success.style.display = 'none';
            
            const data = {
                name: document.getElementById('ruleName').value,
                type: ruleType,
                enabled: document.getElementById('ruleEnabled').checked,
                severity: document.getElementById('ruleSeverity').value,
                notification_methods: ['page']
            };
            
            if (ruleType === 'traffic_threshold') {
                data.threshold_bytes = parseInt(document.getElementById('thresholdBytes').value);
                const deviceId = document.getElementById('ruleDeviceId').value;
                if (deviceId) {
                    data.device_id = parseInt(deviceId);
                }
            } else if (ruleType === 'device_offline') {
                data.offline_threshold_minutes = parseInt(document.getElementById('offlineThresholdMinutes').value);
            }
            
            try {
                const url = ruleId ? `/api/alerts/rules/${ruleId}` : '/api/alerts/rules';
                const method = ruleId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                }
                
                success.style.display = 'block';
                success.textContent = 'è§„åˆ™ä¿å­˜æˆåŠŸ';
                closeRuleForm();
                await loadAlertRules();
                
                setTimeout(() => {
                    success.style.display = 'none';
                }, 3000);
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
                console.error('ä¿å­˜è§„åˆ™å¤±è´¥:', err);
            }
        }
        
        // å…³é—­è§„åˆ™è¡¨å•
        function closeRuleForm() {
            document.getElementById('ruleFormModal').style.display = 'none';
        }
        
        // åˆ é™¤è§„åˆ™
        async function deleteRule(ruleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å‘Šè­¦è§„åˆ™å—ï¼Ÿ')) {
                return;
            }
            
            const error = document.getElementById('alertsError');
            error.style.display = 'none';
            
            try {
                const response = await fetch(`/api/alerts/rules/${ruleId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
                }
                
                await loadAlertRules();
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
                console.error('åˆ é™¤è§„åˆ™å¤±è´¥:', err);
            }
        }
        
        // åŠ è½½å‘Šè­¦å†å²
        async function loadAlertHistory(page = 1) {
            alertHistoryPage = page;
            const error = document.getElementById('alertsError');
            error.style.display = 'none';
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: alertHistoryPerPage
                });
                
                const status = document.getElementById('historyStatusFilter').value;
                if (status) params.append('status', status);
                
                const alertType = document.getElementById('historyTypeFilter').value;
                if (alertType) params.append('alert_type', alertType);
                
                const severity = document.getElementById('historySeverityFilter').value;
                if (severity) params.append('severity', severity);
                
                const response = await fetch(`/api/alerts/history?${params}`, {
                    credentials: 'same-origin'
                });
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½å†å²å¤±è´¥');
                }
                
                const tbody = document.getElementById('alertHistoryTableBody');
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">æš‚æ— å‘Šè­¦å†å²</td></tr>';
                    document.getElementById('alertHistoryPagination').innerHTML = '';
                    return;
                }
                
                const severityColors = {
                    'critical': '#dc3545',
                    'warning': '#ffc107',
                    'info': '#17a2b8'
                };
                const severityTexts = {
                    'critical': 'ä¸¥é‡',
                    'warning': 'è­¦å‘Š',
                    'info': 'ä¿¡æ¯'
                };
                const typeTexts = {
                    'traffic_threshold': 'æµé‡é˜ˆå€¼',
                    'device_offline': 'è®¾å¤‡ç¦»çº¿'
                };
                const statusTexts = {
                    'triggered': 'å·²è§¦å‘',
                    'acknowledged': 'å·²ç¡®è®¤',
                    'resolved': 'å·²è§£å†³'
                };
                const statusColors = {
                    'triggered': '#dc3545',
                    'acknowledged': '#ffc107',
                    'resolved': '#28a745'
                };
                
                tbody.innerHTML = result.data.map(alert => {
                    const triggeredTime = new Date(alert.triggered_at);
                    return `
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${triggeredTime.toLocaleString('zh-CN')}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${typeTexts[alert.alert_type] || alert.alert_type}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${escapeHtml(alert.message)}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                <span style="color: ${severityColors[alert.severity] || '#666'}; font-weight: 500;">
                                    ${severityTexts[alert.severity] || alert.severity}
                                </span>
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="color: ${statusColors[alert.status] || '#666'}; font-weight: 500;">
                                    ${statusTexts[alert.status] || alert.status}
                                </span>
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                                ${alert.status === 'triggered' ? `<button onclick="acknowledgeAlert(${alert.id})" style="padding: 5px 10px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer;">ç¡®è®¤</button>` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // åˆ†é¡µ
                const pagination = result.pagination;
                if (pagination && pagination.pages > 1) {
                    let paginationHtml = '';
                    if (pagination.page > 1) {
                        paginationHtml += `<button onclick="loadAlertHistory(${pagination.page - 1})" style="padding: 8px 15px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer;">ä¸Šä¸€é¡µ</button>`;
                    }
                    paginationHtml += `<span style="padding: 0 15px;">ç¬¬ ${pagination.page} / ${pagination.pages} é¡µ (å…± ${pagination.total} æ¡)</span>`;
                    if (pagination.page < pagination.pages) {
                        paginationHtml += `<button onclick="loadAlertHistory(${pagination.page + 1})" style="padding: 8px 15px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer;">ä¸‹ä¸€é¡µ</button>`;
                    }
                    document.getElementById('alertHistoryPagination').innerHTML = paginationHtml;
                } else {
                    document.getElementById('alertHistoryPagination').innerHTML = '';
                }
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
                console.error('åŠ è½½å‘Šè­¦å†å²å¤±è´¥:', err);
            }
        }
        
        // ç¡®è®¤å‘Šè­¦
        async function acknowledgeAlert(alertId) {
            try {
                const response = await fetch(`/api/alerts/history/${alertId}/acknowledge`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'ç¡®è®¤å¤±è´¥');
                }
                
                // å¦‚æœåœ¨å‘Šè­¦ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°å†å²åˆ—è¡¨
                if (document.getElementById('alertsTab').classList.contains('active')) {
                    await loadAlertHistory(alertHistoryPage);
                }
                // æ›´æ–°æ´»è·ƒå‘Šè­¦é€šçŸ¥
                updateActiveAlerts();
                
            } catch (err) {
                alert('ç¡®è®¤å‘Šè­¦å¤±è´¥: ' + err.message);
                console.error('ç¡®è®¤å‘Šè­¦å¤±è´¥:', err);
            }
        }
        
        // è½¬ä¹‰HTMLï¼ˆä¾›å¤šä¸ªå‡½æ•°ä½¿ç”¨ï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ============ å‘Šè­¦é€šçŸ¥åŠŸèƒ½ ============
        
        // æ›´æ–°æ´»è·ƒå‘Šè­¦é€šçŸ¥
        async function updateActiveAlerts() {
            try {
                const response = await fetch('/api/alerts/active', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    return;
                }
                
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    document.getElementById('activeAlertsBar').style.display = 'none';
                    return;
                }
                
                const alerts = result.data;
                const alertsList = document.getElementById('activeAlertsList');
                
                const severityColors = {
                    'critical': '#dc3545',
                    'warning': '#ffc107',
                    'info': '#17a2b8'
                };
                const severityTexts = {
                    'critical': 'ä¸¥é‡',
                    'warning': 'è­¦å‘Š',
                    'info': 'ä¿¡æ¯'
                };
                
                alertsList.innerHTML = alerts.slice(0, 5).map(alert => {
                    const triggeredTime = new Date(alert.triggered_at);
                    return `
                        <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid ${severityColors[alert.severity] || '#666'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="color: ${severityColors[alert.severity] || '#666'}; font-weight: 500; margin-right: 10px;">
                                        [${severityTexts[alert.severity] || alert.severity}]
                                    </span>
                                    <span>${escapeHtml(alert.message)}</span>
                                    <small style="color: #666; margin-left: 10px;">${triggeredTime.toLocaleString('zh-CN')}</small>
                                </div>
                                <button onclick="acknowledgeAlert(${alert.id}); updateActiveAlerts();" style="padding: 4px 12px; margin-left: 10px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer; font-size: 12px;">ç¡®è®¤</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (alerts.length > 5) {
                    alertsList.innerHTML += `<div style="margin-top: 8px; color: #666; text-align: center;">è¿˜æœ‰ ${alerts.length - 5} æ¡å‘Šè­¦æœªæ˜¾ç¤ºï¼Œ<a href="#" onclick="switchTab('alerts'); event.target.closest('button')?.click(); return false;" style="color: #007bff;">æŸ¥çœ‹å…¨éƒ¨</a></div>`;
                }
                
                // æ ¹æ®æœ€é«˜ä¸¥é‡ç¨‹åº¦è®¾ç½®é€šçŸ¥æ¡é¢œè‰²
                const hasCritical = alerts.some(a => a.severity === 'critical');
                const hasWarning = alerts.some(a => a.severity === 'warning');
                
                const alertBar = document.getElementById('activeAlertsBar');
                if (hasCritical) {
                    alertBar.style.background = '#f8d7da';
                    alertBar.style.borderLeftColor = '#dc3545';
                } else if (hasWarning) {
                    alertBar.style.background = '#fff3cd';
                    alertBar.style.borderLeftColor = '#ffc107';
                } else {
                    alertBar.style.background = '#d1ecf1';
                    alertBar.style.borderLeftColor = '#17a2b8';
                }
                
                document.getElementById('activeAlertsBar').style.display = 'block';
                
            } catch (err) {
                console.debug('åŠ è½½æ´»è·ƒå‘Šè­¦å¤±è´¥:', err);
            }
        }
        
        // ============ æ•°æ®ç®¡ç†åŠŸèƒ½ ============
        
        // åˆå§‹åŒ–æ•°æ®ç®¡ç†é¡µé¢
        async function initDataManagementPage() {
            await loadDatabaseStats();
            await loadBackupInfo();
        }
        
        // åŠ è½½æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
        async function loadDatabaseStats() {
            const error = document.getElementById('dataManagementError');
            error.style.display = 'none';
            
            try {
                const response = await fetch('/api/database/management/stats');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½æ•°æ®å¤±è´¥');
                }
                
                const data = result.data;
                
                // æ›´æ–°æ•°æ®åº“å¤§å°ï¼ˆç›´æ¥æ˜¾ç¤ºæ ¼å¼åŒ–åçš„å®Œæ•´å­—ç¬¦ä¸²ï¼‰
                const databaseSizeEl = document.getElementById('databaseSize');
                const databaseSizeFormattedEl = document.getElementById('databaseSizeFormatted');
                if (databaseSizeEl) {
                    databaseSizeEl.textContent = data.database_size_formatted || '0 B';
                }
                if (databaseSizeFormattedEl) {
                    databaseSizeFormattedEl.textContent = '';
                }
                
                // æ›´æ–°è®°å½•æ•°
                const totalTrafficRecordsEl = document.getElementById('totalTrafficRecords');
                const deviceTrafficRecordsEl = document.getElementById('deviceTrafficRecords');
                const deviceCountEl = document.getElementById('deviceCount');
                
                // ä½¿ç”¨æ›´å…·ä½“çš„IDï¼Œé¿å…ä¸å…¶ä»–é¡µé¢å†²çª
                // æ³¨æ„ï¼šæ•°æ®ç®¡ç†é¡µé¢çš„IDéœ€è¦æ·»åŠ å‰ç¼€ï¼Œæˆ–è€…ä½¿ç”¨æ›´å…·ä½“çš„é€‰æ‹©å™¨
                if (totalTrafficRecordsEl) {
                    totalTrafficRecordsEl.textContent = (data.total_traffic_records || 0).toLocaleString();
                }
                if (deviceTrafficRecordsEl) {
                    deviceTrafficRecordsEl.textContent = (data.device_traffic_records || 0).toLocaleString();
                }
                const managementDeviceCountEl = document.getElementById('managementDeviceCount');
                if (managementDeviceCountEl) {
                    managementDeviceCountEl.textContent = (data.device_count || 0).toLocaleString();
                }
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
                console.error('åŠ è½½æ•°æ®åº“ç»Ÿè®¡å¤±è´¥:', err);
            }
        }
        
        // æ›´æ–°æ¸…ç†UI
        function updateCleanupUI() {
            const cleanupType = document.querySelector('input[name="cleanupType"]:checked').value;
            const keepDaysGroup = document.getElementById('keepDaysGroup');
            const timeRangeGroup = document.getElementById('timeRangeGroup');
            
            if (cleanupType === 'keep_days') {
                keepDaysGroup.style.display = 'block';
                timeRangeGroup.style.display = 'none';
            } else {
                keepDaysGroup.style.display = 'none';
                timeRangeGroup.style.display = 'block';
            }
            
            // éšè—é¢„è§ˆ
            document.getElementById('cleanupPreview').style.display = 'none';
        }
        
        // é¢„è§ˆæ¸…ç†æ“ä½œ
        async function previewCleanup() {
            const error = document.getElementById('dataManagementError');
            const preview = document.getElementById('cleanupPreview');
            error.style.display = 'none';
            
            try {
                const cleanupType = document.querySelector('input[name="cleanupType"]:checked').value;
                let requestData = { preview: true };
                
                if (cleanupType === 'keep_days') {
                    const keepDays = parseInt(document.getElementById('keepDays').value);
                    if (!keepDays || keepDays < 1) {
                        throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¿ç•™å¤©æ•°ï¼ˆè‡³å°‘1å¤©ï¼‰');
                    }
                    requestData.keep_days = keepDays;
                } else {
                    const startTime = document.getElementById('cleanupStartTime').value;
                    const endTime = document.getElementById('cleanupEndTime').value;
                    if (!startTime || !endTime) {
                        throw new Error('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');
                    }
                    requestData.start_time = startTime;
                    requestData.end_time = endTime;
                }
                
                const response = await fetch('/api/database/management/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'é¢„è§ˆå¤±è´¥');
                }
                
                const data = result.data;
                document.getElementById('previewDeleteCount').textContent = data.total_will_delete || 0;
                preview.style.display = 'block';
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
                preview.style.display = 'none';
            }
        }
        
        // æ‰§è¡Œæ•°æ®æ¸…ç†
        async function executeCleanup() {
            const error = document.getElementById('dataManagementError');
            const success = document.getElementById('dataManagementSuccess');
            error.style.display = 'none';
            success.style.display = 'none';
            
            // ç¡®è®¤æ“ä½œ
            const cleanupType = document.querySelector('input[name="cleanupType"]:checked').value;
            let confirmMessage = '';
            
            if (cleanupType === 'keep_days') {
                const keepDays = document.getElementById('keepDays').value;
                confirmMessage = `ç¡®å®šè¦åˆ é™¤ä¿ç•™æœ€è¿‘${keepDays}å¤©ä¹‹å¤–çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
            } else {
                confirmMessage = 'ç¡®å®šè¦åˆ é™¤æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼';
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                let requestData = { preview: false };
                
                if (cleanupType === 'keep_days') {
                    const keepDays = parseInt(document.getElementById('keepDays').value);
                    if (!keepDays || keepDays < 1) {
                        throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¿ç•™å¤©æ•°ï¼ˆè‡³å°‘1å¤©ï¼‰');
                    }
                    requestData.keep_days = keepDays;
                } else {
                    const startTime = document.getElementById('cleanupStartTime').value;
                    const endTime = document.getElementById('cleanupEndTime').value;
                    if (!startTime || !endTime) {
                        throw new Error('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');
                    }
                    requestData.start_time = startTime;
                    requestData.end_time = endTime;
                }
                
                const response = await fetch('/api/database/management/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'æ¸…ç†å¤±è´¥');
                }
                
                const data = result.data;
                success.style.display = 'block';
                success.textContent = `æ¸…ç†æˆåŠŸï¼åˆ é™¤äº† ${data.total_deleted || 0} æ¡è®°å½•ï¼ˆå…¨ç½‘æµé‡ï¼š${data.deleted_total_traffic || 0}ï¼Œè®¾å¤‡æµé‡ï¼š${data.deleted_device_traffic || 0}ï¼‰`;
                
                // é‡æ–°åŠ è½½ç»Ÿè®¡ä¿¡æ¯
                await loadDatabaseStats();
                // éšè—é¢„è§ˆ
                document.getElementById('cleanupPreview').style.display = 'none';
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
            }
        }
        
        // æ‰§è¡Œæ•°æ®åº“ä¼˜åŒ–
        async function executeVacuum() {
            const error = document.getElementById('dataManagementError');
            const success = document.getElementById('dataManagementSuccess');
            const vacuumResult = document.getElementById('vacuumResult');
            error.style.display = 'none';
            success.style.display = 'none';
            vacuumResult.style.display = 'none';
            
            if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ•°æ®åº“ä¼˜åŒ–å—ï¼Ÿæ­¤æ“ä½œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/api/database/management/vacuum', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'ä¼˜åŒ–å¤±è´¥');
                }
                
                const data = result.data;
                vacuumResult.style.display = 'block';
                vacuumResult.innerHTML = `
                    <div style="background: #d4edda; padding: 10px; border-radius: 4px; color: #155724;">
                        <strong>ä¼˜åŒ–å®Œæˆï¼</strong><br>
                        ä¼˜åŒ–å‰å¤§å°ï¼š${data.size_before_formatted}<br>
                        ä¼˜åŒ–åå¤§å°ï¼š${data.size_after_formatted}<br>
                        é‡Šæ”¾ç©ºé—´ï¼š${data.size_reduced_formatted}
                    </div>
                `;
                
                // é‡æ–°åŠ è½½ç»Ÿè®¡ä¿¡æ¯
                await loadDatabaseStats();
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
            }
        }
        
        // åŠ è½½å¤‡ä»½ä¿¡æ¯
        async function loadBackupInfo() {
            try {
                const response = await fetch('/api/database/management/backup-info');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    const backupInfo = document.getElementById('backupInfo');
                    document.getElementById('backupDatabaseSize').textContent = data.database_size_formatted || '-';
                    document.getElementById('backupRecordCount').textContent = 
                        `${(data.total_traffic_records || 0).toLocaleString()} æ¡å…¨ç½‘æµé‡è®°å½•ï¼Œ${(data.device_traffic_records || 0).toLocaleString()} æ¡è®¾å¤‡æµé‡è®°å½•`;
                    backupInfo.style.display = 'block';
                }
            } catch (err) {
                console.error('åŠ è½½å¤‡ä»½ä¿¡æ¯å¤±è´¥:', err);
            }
        }
        
        // ä¸‹è½½æ•°æ®åº“å¤‡ä»½
        async function downloadBackup() {
            try {
                const response = await fetch('/api/database/management/backup');
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ä¸‹è½½å¤±è´¥');
                }
                
                // è·å–æ–‡ä»¶åï¼ˆä»Content-Dispositionå¤´æˆ–ä½¿ç”¨é»˜è®¤åç§°ï¼‰
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'traffic_data_backup.sql';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('å¤‡ä»½æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼');
                
            } catch (err) {
                const error = document.getElementById('dataManagementError');
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
            }
        }
        
        // æ ¼å¼åŒ–æ•°æ®åº“å¤§å°
        function formatDatabaseSize(bytes) {
            if (bytes < 1024) {
                return { value: bytes.toFixed(0), unit: 'B' };
            } else if (bytes < 1024 * 1024) {
                return { value: (bytes / 1024).toFixed(1), unit: 'KB' };
            } else if (bytes < 1024 * 1024 * 1024) {
                return { value: (bytes / (1024 * 1024)).toFixed(2), unit: 'MB' };
            } else {
                return { value: (bytes / (1024 * 1024 * 1024)).toFixed(2), unit: 'GB' };
            }
        }
        
        // ============ æ•°æ®å›¾è¡¨åŠŸèƒ½ ============
        window.trafficTrendChart = null;
        window.deviceComparisonChart = null;
        
        // åˆå§‹åŒ–å›¾è¡¨é¡µé¢
        async function initChartsPage() {
            // åŠ è½½è®¾å¤‡åˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
            await loadDevicesForChart();
            
            // ç›‘å¬å›¾è¡¨ç±»å‹å˜åŒ–
            const chartTypeSelect = document.getElementById('chartTypeSelect');
            if (chartTypeSelect) {
                chartTypeSelect.addEventListener('change', function() {
                    const chartType = this.value;
                    const deviceGroup = document.getElementById('deviceSelectorGroup');
                    
                    if (chartType === 'traffic_trend') {
                        deviceGroup.style.display = 'block';
                    } else {
                        deviceGroup.style.display = 'none';
                    }
                    
                    // éšè—æ‰€æœ‰å›¾è¡¨
                    document.getElementById('trafficTrendChart').style.display = 'none';
                    document.getElementById('deviceComparisonChart').style.display = 'none';
                });
            }
            
            // é»˜è®¤åŠ è½½æµé‡è¶‹åŠ¿å›¾ï¼ˆå…¨ç½‘æµé‡ï¼Œæœ€è¿‘24å°æ—¶ï¼‰
            loadChart();
        }
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨åˆ°å›¾è¡¨è®¾å¤‡é€‰æ‹©å™¨
        async function loadDevicesForChart() {
            try {
                const response = await fetch('/api/database/devices');
                const result = await response.json();
                
                const deviceSelect = document.getElementById('chartDeviceSelect');
                if (deviceSelect) {
                    deviceSelect.innerHTML = '<option value="total">å…¨ç½‘æµé‡</option>';
                    
                    if (result.success && result.data) {
                        result.data.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.id;
                            option.textContent = `${device.hostname || 'æœªçŸ¥'} (${device.mac})`;
                            deviceSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å›¾è¡¨
        async function loadChart() {
            const chartType = document.getElementById('chartTypeSelect').value;
            
            if (chartType === 'traffic_trend') {
                await loadTrafficTrendChart();
            } else if (chartType === 'device_comparison') {
                await loadDeviceComparison();
            }
        }
        
        // åŠ è½½æµé‡è¶‹åŠ¿å›¾
        async function loadTrafficTrendChart() {
            const loading = document.getElementById('chartLoading');
            const error = document.getElementById('chartError');
            const chartContainer = document.getElementById('trafficTrendChart');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            chartContainer.style.display = 'none';
            
            try {
                const deviceSelect = document.getElementById('chartDeviceSelect');
                const timeRange = document.getElementById('timeRangeSelect').value;
                const deviceId = deviceSelect.value;
                
                let url = `/api/database/charts/traffic-trend?hours=${timeRange}&interval=5`;
                
                if (deviceId === 'total') {
                    url += '&type=total';
                } else {
                    url += `&type=device&device_id=${deviceId}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥');
                }
                
                // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
                chartContainer.style.display = 'block';
                document.getElementById('deviceComparisonChart').style.display = 'none';
                
                // å‡†å¤‡æ•°æ®
                const labels = result.data.map(item => {
                    const date = new Date(item.timestamp);
                    return date.toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                });
                
                const downSpeedData = result.data.map(item => (item.down_speed / 1024).toFixed(2)); // KB/s
                const upSpeedData = result.data.map(item => (item.up_speed / 1024).toFixed(2)); // KB/s
                
                // é”€æ¯æ—§å›¾è¡¨
                if (window.trafficTrendChart) {
                    window.trafficTrendChart.destroy();
                }
                
                // åˆ›å»ºæ–°å›¾è¡¨
                const ctx = document.getElementById('trafficTrendCanvas').getContext('2d');
                const chartTheme = getChartThemeConfig();
                window.trafficTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ä¸‹è¡Œé€Ÿç‡ (KB/s)',
                            data: downSpeedData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }, {
                            label: 'ä¸Šè¡Œé€Ÿç‡ (KB/s)',
                            data: upSpeedData,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: deviceId === 'total' ? 'å…¨ç½‘æµé‡è¶‹åŠ¿' : 'è®¾å¤‡æµé‡è¶‹åŠ¿',
                                color: chartTheme.textColor
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: chartTheme.textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: chartTheme.textColor
                                },
                                grid: {
                                    color: chartTheme.gridColor
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: chartTheme.textColor
                                },
                                grid: {
                                    color: chartTheme.gridColor
                                },
                                title: {
                                    display: true,
                                    text: 'é€Ÿç‡ (KB/s)',
                                    color: chartTheme.textColor
                                }
                            }
                        }
                    }
                });
                
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
            }
        }
        
        // åŠ è½½è®¾å¤‡å¯¹æ¯”å›¾
        async function loadDeviceComparison() {
            const loading = document.getElementById('chartLoading');
            const error = document.getElementById('chartError');
            const chartContainer = document.getElementById('deviceComparisonChart');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            chartContainer.style.display = 'none';
            
            try {
                const timeRange = document.getElementById('timeRangeSelect').value;
                const comparisonType = document.querySelector('input[name="comparisonType"]:checked').value;
                
                const url = `/api/database/charts/device-comparison?hours=${timeRange}&type=${comparisonType}`;
                const response = await fetch(url);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥');
                }
                
                // åªæ˜¾ç¤ºå‰10ä¸ªè®¾å¤‡
                const data = result.data.slice(0, 10);
                
                if (data.length === 0) {
                    throw new Error('æš‚æ— æ•°æ®');
                }
                
                // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
                chartContainer.style.display = 'block';
                document.getElementById('trafficTrendChart').style.display = 'none';
                
                // å‡†å¤‡æ•°æ®
                const labels = data.map(item => item.device_name);
                
                let dataset1, dataset2, yAxisLabel;
                
                if (comparisonType === 'speed') {
                    dataset1 = {
                        label: 'ä¸‹è¡Œé€Ÿç‡ (KB/s)',
                        data: data.map(item => (item.down_speed / 1024).toFixed(2)),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    };
                    dataset2 = {
                        label: 'ä¸Šè¡Œé€Ÿç‡ (KB/s)',
                        data: data.map(item => (item.up_speed / 1024).toFixed(2)),
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    };
                    yAxisLabel = 'é€Ÿç‡ (KB/s)';
                } else {
                    dataset1 = {
                        label: 'ä¸‹è½½æµé‡ (MB)',
                        data: data.map(item => (item.total_download / 1024 / 1024).toFixed(2)),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    };
                    dataset2 = {
                        label: 'ä¸Šä¼ æµé‡ (MB)',
                        data: data.map(item => (item.total_upload / 1024 / 1024).toFixed(2)),
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    };
                    yAxisLabel = 'æµé‡ (MB)';
                }
                
                // é”€æ¯æ—§å›¾è¡¨
                if (window.deviceComparisonChart) {
                    window.deviceComparisonChart.destroy();
                }
                
                // åˆ›å»ºæ–°å›¾è¡¨
                const ctx = document.getElementById('deviceComparisonCanvas').getContext('2d');
                const chartTheme = getChartThemeConfig();
                window.deviceComparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [dataset1, dataset2]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: comparisonType === 'speed' ? 'è®¾å¤‡é€Ÿç‡å¯¹æ¯”' : 'è®¾å¤‡æµé‡å¯¹æ¯”',
                                color: chartTheme.textColor
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: chartTheme.textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: chartTheme.textColor
                                },
                                grid: {
                                    color: chartTheme.gridColor
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: chartTheme.textColor
                                },
                                grid: {
                                    color: chartTheme.gridColor
                                },
                                title: {
                                    display: true,
                                    text: yAxisLabel,
                                    color: chartTheme.textColor
                                }
                            }
                        }
                    }
                });
                
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
            }
        }
    </script>
    
    <!-- Chart.js åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- SheetJS (xlsx) åº“ - ç”¨äºExcelå¯¼å‡º -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- ============ å®æ—¶ç›‘æ§ä»ªè¡¨ç›˜åŠŸèƒ½ ============ -->
    <script>
        let dashboardRefreshInterval = null;
        let dashboardRefreshIntervalSeconds = 10;
        
        // åˆå§‹åŒ–ä»ªè¡¨ç›˜
        function initDashboard() {
            // åŠ è½½æ•°æ®
            loadDashboardData();
            
            // è®¾ç½®åˆ·æ–°é—´éš”
            const intervalSelect = document.getElementById('refreshIntervalSelect');
            if (intervalSelect) {
                intervalSelect.addEventListener('change', function() {
                    const interval = parseInt(this.value);
                    dashboardRefreshIntervalSeconds = interval;
                    setupAutoRefresh(interval);
                });
                
                // åˆå§‹è®¾ç½®
                setupAutoRefresh(dashboardRefreshIntervalSeconds);
            }
        }
        
        // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
        function setupAutoRefresh(intervalSeconds) {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
            
            // å¦‚æœé—´éš”å¤§äº0ï¼Œè®¾ç½®æ–°çš„å®šæ—¶å™¨
            if (intervalSeconds > 0) {
                dashboardRefreshInterval = setInterval(() => {
                    loadDashboardData();
                }, intervalSeconds * 1000);
            }
        }
        
        // æ‰‹åŠ¨åˆ·æ–°
        function manualRefreshDashboard() {
            loadDashboardData();
        }
        
        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboardData() {
            const error = document.getElementById('dashboardError');
            
            error.style.display = 'none';
            
            try {
                const response = await fetch('/api/database/dashboard');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'åŠ è½½æ•°æ®å¤±è´¥');
                }
                
                const data = result.data;
                
                // æ›´æ–°å®æ—¶æµé‡å¡ç‰‡
                if (data.total) {
                    updateTrafficCards(data.total);
                }
                
                // æ›´æ–°ç³»ç»ŸçŠ¶æ€
                if (data.system_status) {
                    updateSystemStatus(data.system_status);
                }
                
                // æ›´æ–°è®¾å¤‡åˆ—è¡¨å’Œæ’è¡Œæ¦œ
                if (data.devices) {
                    updateDeviceRanking(data.devices);
                }
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = 'é”™è¯¯: ' + err.message;
            }
        }
        
        // æ›´æ–°æµé‡å¡ç‰‡
        function updateTrafficCards(totalData) {
            // ä¸‹è¡Œé€Ÿç‡
            document.getElementById('currentDownSpeed').textContent = totalData.down_speed_formatted || '0 B/s';
            document.getElementById('currentDownSpeedFormatted').textContent = '';
            
            // ä¸Šè¡Œé€Ÿç‡
            document.getElementById('currentUpSpeed').textContent = totalData.up_speed_formatted || '0 B/s';
            document.getElementById('currentUpSpeedFormatted').textContent = '';
            
            // æ€»ä¸‹è½½æµé‡
            document.getElementById('totalDownload').textContent = totalData.total_download_formatted || '0 B';
            document.getElementById('totalDownloadFormatted').textContent = '';
            
            // æ€»ä¸Šä¼ æµé‡
            document.getElementById('totalUpload').textContent = totalData.total_upload_formatted || '0 B';
            document.getElementById('totalUploadFormatted').textContent = '';
        }
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(status) {
            document.getElementById('collectorStatus').textContent = status.collector_status || '-';
            document.getElementById('totalRecords').textContent = (status.total_records || 0).toLocaleString();
            document.getElementById('deviceCount').textContent = (status.device_count || 0).toLocaleString();
            
            if (status.latest_data_time) {
                const date = new Date(status.latest_data_time);
                document.getElementById('latestDataTime').textContent = date.toLocaleString('zh-CN');
            } else {
                document.getElementById('latestDataTime').textContent = '-';
            }
        }
        
        // æ›´æ–°è®¾å¤‡æ’è¡Œæ¦œ
        function updateDeviceRanking(devices) {
            const tableBody = document.getElementById('rankingTableBody');
            const tableContainer = document.getElementById('deviceRankingTable');
            const empty = document.getElementById('rankingEmpty');
            
            if (!devices || devices.length === 0) {
                tableContainer.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            empty.style.display = 'none';
            
            // åªæ˜¾ç¤ºTop 10
            const topDevices = devices.slice(0, 10);
            
            tableBody.innerHTML = topDevices.map((device, index) => {
                const statusClass = device.is_online ? 'online' : 'offline';
                const statusText = device.is_online ? 'åœ¨çº¿' : 'ç¦»çº¿';
                const totalTrafficFormatted = formatBytesToSize(device.total_traffic_bytes);
                const lastActive = device.last_active ? new Date(device.last_active).toLocaleString('zh-CN') : '-';
                
                return `
                    <tr>
                        <td><span class="device-status ${statusClass}"></span>${statusText}</td>
                        <td>${escapeHtml(device.hostname)}</td>
                        <td>${escapeHtml(device.mac)}</td>
                        <td>${escapeHtml(device.ip)}</td>
                        <td>${device.down_speed_formatted || '-'}</td>
                        <td>${device.up_speed_formatted || '-'}</td>
                        <td>${totalTrafficFormatted}</td>
                        <td>${lastActive}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ ¼å¼åŒ–é€Ÿåº¦å€¼ï¼ˆç”¨äºå¤§æ•°å­—æ˜¾ç¤ºï¼‰
        function formatSpeedValue(bytesPerSecond) {
            if (bytesPerSecond < 1024) {
                return { value: bytesPerSecond.toFixed(0), unit: 'B/s' };
            } else if (bytesPerSecond < 1024 * 1024) {
                return { value: (bytesPerSecond / 1024).toFixed(1), unit: 'KB/s' };
            } else if (bytesPerSecond < 1024 * 1024 * 1024) {
                return { value: (bytesPerSecond / (1024 * 1024)).toFixed(2), unit: 'MB/s' };
            } else {
                return { value: (bytesPerSecond / (1024 * 1024 * 1024)).toFixed(2), unit: 'GB/s' };
            }
        }
        
        // æ ¼å¼åŒ–å¤§å°å€¼ï¼ˆç”¨äºå¤§æ•°å­—æ˜¾ç¤ºï¼‰
        function formatSizeValue(bytes) {
            if (bytes < 1024) {
                return { value: bytes.toFixed(0), unit: 'B' };
            } else if (bytes < 1024 * 1024) {
                return { value: (bytes / 1024).toFixed(1), unit: 'KB' };
            } else if (bytes < 1024 * 1024 * 1024) {
                return { value: (bytes / (1024 * 1024)).toFixed(2), unit: 'MB' };
            } else if (bytes < 1024 * 1024 * 1024 * 1024) {
                return { value: (bytes / (1024 * 1024 * 1024)).toFixed(2), unit: 'GB' };
            } else {
                return { value: (bytes / (1024 * 1024 * 1024 * 1024)).toFixed(2), unit: 'TB' };
            }
        }
        
        // æ ¼å¼åŒ–å­—èŠ‚ä¸ºå¯è¯»å¤§å°
        function formatBytesToSize(bytes) {
            const formatted = formatSizeValue(bytes);
            return `${formatted.value} ${formatted.unit}`;
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
            }
        });
    </script>
</body>
</html>
